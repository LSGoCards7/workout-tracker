<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Iron Log">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<title>IRON LOG</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'JetBrains Mono', monospace;
    background: #0f172a;
    color: #e2e8f0;
    min-height: 100vh;
    min-height: 100dvh;
    overflow-x: hidden;
  }

  #app {
    max-width: 480px;
    margin: 0 auto;
    padding: 16px 16px 100px;
  }

  /* ===== HEADER ===== */
  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; padding-top: 12px; }
  .header h1 { font-size: 28px; font-weight: 800; letter-spacing: 6px; color: #f8fafc; }
  .header .sub { font-size: 11px; color: #64748b; margin-top: 4px; letter-spacing: 1px; text-transform: uppercase; }
  .week-badge { display: flex; flex-direction: column; align-items: center; background: #1e293b; padding: 8px 14px; border-radius: 8px; border: 1px solid #334155; }
  .week-badge .num { font-size: 24px; font-weight: 700; color: #4ade80; }
  .week-badge .label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }

  /* ===== TODAY CARD ===== */
  .today-card { background: linear-gradient(135deg, #1e293b 0%, #0f2a1e 100%); border: 1px solid #22543d; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
  .today-card .label { font-size: 11px; color: #4ade80; letter-spacing: 2px; font-weight: 600; margin-bottom: 8px; }
  .today-card h2 { font-size: 22px; font-weight: 700; color: #f8fafc; margin-bottom: 4px; }
  .today-card .sub { font-size: 13px; color: #94a3b8; margin-bottom: 16px; }

  .rest-day-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; margin-bottom: 24px; text-align: center; }
  .rest-day-card h2 { font-size: 18px; font-weight: 600; color: #94a3b8; margin-bottom: 4px; }
  .rest-day-card p { font-size: 13px; color: #64748b; }

  /* ===== BUTTONS ===== */
  .btn-primary { background: #4ade80; color: #0f172a; border: none; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 700; font-family: inherit; cursor: pointer; width: 100%; letter-spacing: 1px; }
  .btn-primary:active { background: #22c55e; }
  .btn-outline { background: none; border: 1px solid #334155; border-radius: 6px; color: #94a3b8; padding: 6px 12px; font-size: 12px; font-family: inherit; cursor: pointer; }
  .btn-finish { background: #4ade80; color: #0f172a; border: none; border-radius: 6px; padding: 6px 14px; font-size: 12px; font-weight: 700; font-family: inherit; cursor: pointer; }
  .btn-finish-lg { background: #4ade80; color: #0f172a; border: none; border-radius: 10px; padding: 14px 24px; font-size: 15px; font-weight: 700; font-family: inherit; cursor: pointer; width: 100%; margin-top: 24px; letter-spacing: 1px; }
  .btn-done { background: #334155; border: none; border-radius: 4px; color: #4ade80; padding: 4px 12px; font-size: 12px; font-weight: 600; font-family: inherit; cursor: pointer; }
  .btn-done:active { background: #475569; }
  .btn-reset { background: none; border: 1px solid #7f1d1d; border-radius: 6px; color: #f87171; padding: 8px 16px; font-size: 12px; font-family: inherit; cursor: pointer; margin-top: 32px; width: 100%; }
  .btn-skip { background: none; border: 1px solid #fb923c; border-radius: 4px; color: #fb923c; padding: 4px 10px; font-size: 11px; font-family: inherit; cursor: pointer; }

  /* ===== SECTIONS ===== */
  .section { margin-bottom: 28px; }
  .section-title { font-size: 12px; font-weight: 600; color: #64748b; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; }

  /* ===== DAY GRID ===== */
  .day-grid { display: flex; flex-direction: column; gap: 8px; }
  .day-card { display: flex; align-items: center; gap: 12px; background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 12px 16px; cursor: pointer; font-family: inherit; color: #e2e8f0; text-align: left; width: 100%; }
  .day-card:active { background: #334155; }
  .day-card.done { border-color: #4ade80; }
  .day-card .name { font-size: 14px; font-weight: 600; min-width: 70px; }
  .day-card .sub { font-size: 12px; color: #94a3b8; flex: 1; }
  .day-card .done-label { font-size: 11px; color: #4ade80; font-weight: 600; }

  /* ===== CHECKLIST ===== */
  .checklist-row { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; background: none; border: none; cursor: pointer; font-family: inherit; text-align: left; width: 100%; color: #e2e8f0; border-bottom: 1px solid #1e293b; }
  .checkbox { width: 20px; height: 20px; min-width: 20px; border-radius: 4px; border: 2px solid #475569; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #0f172a; margin-top: 1px; transition: all 0.15s; }
  .checkbox.checked { background: #4ade80; border-color: #4ade80; }
  .checklist-text { font-size: 13px; line-height: 1.4; color: #cbd5e1; }
  .checklist-text.checked { text-decoration: line-through; opacity: 0.6; }
  .checklist-score { text-align: right; font-size: 13px; color: #4ade80; font-weight: 600; margin-top: 8px; }

  /* ===== NAV BAR ===== */
  .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; border-top: 1px solid #334155; display: flex; justify-content: center; gap: 48px; padding: 12px 0; z-index: 100; }
  .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; cursor: pointer; font-family: inherit; color: #94a3b8; }
  .nav-btn .icon { font-size: 20px; }
  .nav-btn .label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

  /* ===== WORKOUT VIEW ===== */
  .workout-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-top: 8px; }
  .workout-header .center h1 { font-size: 20px; font-weight: 700; color: #f8fafc; text-align: center; }
  .workout-header .center p { font-size: 12px; color: #64748b; text-align: center; margin-top: 2px; }

  #rest-timer { position: fixed; top: 0; left: 0; right: 0; z-index: 150; }
  #rest-timer:empty { display: none; }
  .rest-pill { background: rgba(124,45,18,0.92); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding: 10px 20px; display: flex; align-items: center; justify-content: center; gap: 16px; }
  .rest-pill .rest-label { font-size: 12px; font-weight: 700; color: #fed7aa; letter-spacing: 2px; }
  .rest-pill .rest-time { font-size: 28px; font-weight: 800; color: #fb923c; font-variant-numeric: tabular-nums; }
  .timer-active { padding-top: 56px; }

  .exercise-list { display: flex; flex-direction: column; gap: 16px; }
  .exercise-card { background: #1e293b; border-radius: 10px; padding: 16px; border: 1px solid #334155; border-left: 4px solid #334155; }
  .exercise-card.completed { border-left-color: #4ade80; }
  .ex-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .ex-name { font-size: 15px; font-weight: 700; color: #f1f5f9; margin-bottom: 4px; }
  .ex-meta { font-size: 11px; color: #64748b; }
  .ex-note { font-size: 11px; color: #94a3b8; margin-top: 4px; font-style: italic; }
  .ex-check { font-size: 20px; color: #4ade80; font-weight: 700; }

  .controls-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
  .control-group { flex: 1; min-width: 120px; }
  .control-label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 6px; }
  .number-input { display: flex; align-items: center; background: #0f172a; border-radius: 6px; border: 1px solid #334155; overflow: hidden; }
  .num-btn { background: #334155; border: none; color: #e2e8f0; padding: 8px 14px; font-size: 16px; font-family: inherit; cursor: pointer; font-weight: 700; }
  .num-btn:active { background: #475569; }
  .num-btn-sm { background: #334155; border: none; color: #e2e8f0; padding: 4px 10px; font-size: 14px; font-family: inherit; cursor: pointer; font-weight: 700; }
  .num-btn-sm:active { background: #475569; }
  .num-value { flex: 1; text-align: center; font-size: 16px; font-weight: 700; color: #f8fafc; }
  .num-value-sm { width: 32px; text-align: center; font-size: 14px; font-weight: 700; color: #f8fafc; }

  .technique-select { background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; padding: 8px 10px; font-size: 12px; font-family: inherit; width: 100%; appearance: none; -webkit-appearance: none; }

  .sets-container { display: flex; flex-direction: column; gap: 6px; }
  .set-row { display: flex; align-items: center; gap: 10px; padding: 6px 8px; background: #0f172a; border-radius: 6px; }
  .set-row.done { opacity: 0.6; }
  .set-label { font-size: 12px; color: #64748b; font-weight: 600; min-width: 40px; }
  .reps-label { font-size: 11px; color: #64748b; flex: 1; }
  .done-check { color: #4ade80; font-weight: 700; font-size: 16px; width: 40px; text-align: center; }

  .notes-input { width: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #94a3b8; padding: 8px 10px; font-size: 12px; font-family: inherit; margin-top: 10px; }

  /* ===== HISTORY ===== */
  .history-date { font-size: 13px; color: #4ade80; font-weight: 600; margin-bottom: 8px; letter-spacing: 1px; }
  .history-card { background: #1e293b; border-radius: 8px; padding: 14px; margin-bottom: 8px; border: 1px solid #334155; }
  .history-day-name { font-size: 14px; font-weight: 700; color: #f1f5f9; margin-bottom: 10px; }
  .history-ex-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #0f172a; }
  .history-ex-name { font-size: 12px; color: #cbd5e1; }
  .history-ex-detail { font-size: 11px; color: #64748b; text-align: right; }

  /* ===== PROGRESS ===== */
  .progress-day-title { font-size: 14px; font-weight: 700; color: #4ade80; margin-bottom: 10px; letter-spacing: 1px; }
  .progress-ex-row { background: #1e293b; border-radius: 8px; padding: 10px 14px; margin-bottom: 6px; border: 1px solid #334155; }
  .progress-ex-name { font-size: 13px; font-weight: 600; color: #f1f5f9; margin-bottom: 4px; }
  .progress-stats { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .progress-stat { font-size: 12px; color: #94a3b8; }
  .progress-diff { font-size: 12px; font-weight: 700; }
  .progress-diff.up { color: #4ade80; }
  .progress-diff.down { color: #f87171; }
  .progress-sep { font-size: 12px; color: #334155; }
  .progress-sessions { font-size: 10px; color: #64748b; margin-top: 4px; }

  .empty-text { color: #64748b; font-size: 14px; text-align: center; padding: 40px 0; }
  .nav-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 8px; }
  .page-title { font-size: 20px; font-weight: 700; color: #f8fafc; }
  .saving { position: fixed; bottom: 60px; right: 16px; background: #334155; color: #94a3b8; padding: 6px 12px; border-radius: 6px; font-size: 11px; z-index: 200; }

  .history-block { margin-bottom: 20px; }
  .progress-block { margin-bottom: 24px; }

  /* ===== SETTINGS ===== */
  .gear-btn { background: none; border: 1px solid #334155; border-radius: 8px; padding: 8px 10px; cursor: pointer; font-size: 18px; line-height: 1; }
  .settings-section { margin-bottom: 28px; }
  .settings-section-title { font-size: 12px; font-weight: 600; color: #64748b; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; }
  .settings-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #1e293b; }
  .settings-row .info { flex: 1; }
  .settings-row .info .title { font-size: 14px; color: #e2e8f0; font-weight: 600; }
  .settings-row .info .sub { font-size: 11px; color: #64748b; margin-top: 2px; }
  .settings-btn { background: #1e293b; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; padding: 8px 16px; font-size: 12px; font-family: inherit; cursor: pointer; font-weight: 600; white-space: nowrap; }
  .settings-btn:active { background: #334155; }
  .settings-btn.primary { background: #4ade80; color: #0f172a; border-color: #4ade80; }
  .settings-btn.primary:active { background: #22c55e; }
  .settings-btn.danger { background: none; border-color: #7f1d1d; color: #f87171; }
  .settings-btn.danger:active { background: #7f1d1d; }
  .settings-stat { text-align: center; flex: 1; }
  .settings-stat .num { font-size: 24px; font-weight: 700; color: #4ade80; }
  .settings-stat .label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
  .settings-stats { display: flex; gap: 12px; padding: 16px; background: #1e293b; border-radius: 10px; border: 1px solid #334155; margin-bottom: 8px; }
  .backup-reminder { background: linear-gradient(135deg, #7c2d12 0%, #92400e 100%); border: 1px solid #b45309; border-radius: 10px; padding: 14px 16px; margin-bottom: 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
  .backup-reminder .msg { flex: 1; }
  .backup-reminder .msg .title { font-size: 13px; font-weight: 700; color: #fed7aa; }
  .backup-reminder .msg .sub { font-size: 11px; color: #fbbf24; margin-top: 2px; }
  .backup-dismiss { background: none; border: none; color: #fed7aa; font-size: 18px; cursor: pointer; padding: 4px 8px; font-family: inherit; }

  /* ===== FILE PROTOCOL BANNER ===== */
  .file-banner { background: #92400e; color: #fef3c7; padding: 10px 16px; font-size: 12px; text-align: center; line-height: 1.4; }
  .file-banner a { color: #fbbf24; font-weight: 700; }

  /* ===== TOAST ===== */
  #toast { position: fixed; top: -60px; left: 50%; transform: translateX(-50%); z-index: 200; transition: top 0.3s ease; pointer-events: none; }
  #toast.show { top: 12px; }
  .toast-pill { background: rgba(30,41,59,0.95); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid #334155; border-radius: 8px; padding: 10px 20px; font-size: 12px; font-weight: 600; color: #e2e8f0; white-space: nowrap; }
  .toast-pill.success { border-color: #22543d; color: #4ade80; }
  .toast-pill.error { border-color: #7f1d1d; color: #f87171; }

  /* ===== SYNC STATUS ===== */
  .sync-key-input { width: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; padding: 10px 12px; font-size: 13px; font-family: inherit; }
  .sync-key-input::placeholder { color: #475569; }
  .sync-key-row { display: flex; gap: 8px; margin-bottom: 8px; }
  .sync-key-row input { flex: 1; }
  .sync-status-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; }
  .sync-status-badge.synced { background: #14532d; color: #4ade80; }
  .sync-status-badge.syncing { background: #1e3a5f; color: #60a5fa; }
  .sync-status-badge.offline { background: #3f3f46; color: #a1a1aa; }
  .sync-status-badge.error { background: #450a0a; color: #f87171; }
  .sync-status-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
  .sync-status-badge.syncing .dot { animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
  .sync-meta { font-size: 11px; color: #64748b; margin-top: 6px; }

  /* ===== TABLET (768px+) ===== */
  @media (min-width: 768px) {
    #app { max-width: 720px; padding: 24px 32px 100px; }
    .header h1 { font-size: 32px; }
    .header .sub { font-size: 12px; }
    .today-card h2 { font-size: 24px; }
    .today-card .sub { font-size: 14px; }
    .btn-primary { font-size: 15px; padding: 14px 24px; }
    .day-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .day-card .name { font-size: 15px; }
    .day-card .sub { font-size: 13px; }
    .exercise-card { padding: 20px; }
    .ex-name { font-size: 16px; }
    .section-title { font-size: 13px; }
    .nav-bar { gap: 80px; }
    .rest-pill { max-width: 720px; margin: 0 auto; }
    .timer-active { padding-top: 56px; }
    .page-title { font-size: 22px; }
    .checklist-text { font-size: 14px; }
  }

  /* ===== DESKTOP (1200px+) ===== */
  @media (min-width: 1200px) {
    #app { max-width: 1000px; padding: 32px 40px 100px; }
    .header h1 { font-size: 36px; }
    .header .sub { font-size: 13px; }
    .today-card { padding: 24px; }
    .today-card h2 { font-size: 26px; }
    .btn-primary { font-size: 16px; }
    .day-grid { grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .day-card .name { font-size: 15px; min-width: 80px; }
    .exercise-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; align-items: start; }
    .exercise-card { padding: 20px; }
    .ex-name { font-size: 17px; }
    .section-title { font-size: 13px; }
    .nav-bar { gap: 120px; }
    .rest-pill { max-width: 1000px; }
    .timer-active { padding-top: 60px; }
    .page-title { font-size: 24px; }
    .history-block .history-card { display: inline-block; width: calc(50% - 4px); vertical-align: top; }
    .history-block .history-card:nth-child(odd) { margin-right: 4px; }
    .progress-ex-row { display: inline-block; width: calc(50% - 4px); vertical-align: top; }
    .progress-ex-row:nth-child(odd) { margin-right: 4px; }
  }
</style>
</head>
<body>
<div id="file-banner"></div>
<div id="app"></div>
<div id="rest-timer"></div>
<div id="toast"></div>

<script>
// ===== SYNC CONFIG =====
const SYNC_WORKER_URL = 'https://ironlog-sync.lds3.workers.dev';
const SYNC_DEBOUNCE_MS = 5000;

const PROGRAM = {
  "Lower A": {
    subtitle: "Quad Focus",
    exercises: [
      { name: "Bulgarian Split Squat", sets: 4, repsLow: 8, repsHigh: 10, tempo: "3-1-1-0", defaultWeight: 45, note: "Each leg. Front foot elevated if possible.", rest: 90 },
      { name: "Goblet Squat (1.5 rep)", sets: 3, repsLow: 8, repsHigh: 10, tempo: "Controlled", defaultWeight: 50, note: "Down, halfway up, back down, all the way up = 1 rep.", rest: 90 },
      { name: "DB Walking Lunge", sets: 3, repsLow: 12, repsHigh: 12, tempo: "Controlled", defaultWeight: 40, note: "Each leg. Long stride, upright torso.", rest: 60 },
      { name: "Single Leg DB RDL", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-0-1-1", defaultWeight: 40, note: "Each leg. Squeeze glute at top.", rest: 60 },
      { name: "Single Leg Calf Raise", sets: 3, repsLow: 15, repsHigh: 20, tempo: "2-1-1-1", defaultWeight: 45, note: "Each leg. Stand on step edge.", rest: 60 },
    ],
  },
  "Upper A": {
    subtitle: "Push Focus",
    exercises: [
      { name: "DB Floor Press", sets: 4, repsLow: 8, repsHigh: 10, tempo: "3-2-1-0", defaultWeight: 50, note: "2-sec pause at bottom eliminates stretch reflex.", rest: 90 },
      { name: "Incline DB Press", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-1-1-0", defaultWeight: 42, note: "Use angled surface or propped pillows.", rest: 90 },
      { name: "Seated OH Press (wall)", sets: 3, repsLow: 8, repsHigh: 10, tempo: "3-1-1-0", defaultWeight: 40, note: "Back against wall. No leaning.", rest: 90 },
      { name: "Lateral Raise", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-1-2-0", defaultWeight: 17, note: "Slow up AND down. No swinging.", rest: 60 },
      { name: "OH Tricep Extension", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-1-1-0", defaultWeight: 45, note: "Both arms, single DB.", rest: 60 },
    ],
  },
  "Lower B": {
    subtitle: "Hinge Focus",
    exercises: [
      { name: "DB Romanian Deadlift", sets: 4, repsLow: 8, repsHigh: 10, tempo: "4-1-1-1", defaultWeight: 50, note: "4-sec lowering. Feel hamstring stretch.", rest: 90 },
      { name: "DB Sumo Squat", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-2-1-0", defaultWeight: 50, note: "Single DB held at center. 2-sec pause.", rest: 90 },
      { name: "Single Leg Hip Thrust", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-2-1-0", defaultWeight: 35, note: "Each leg. Back on couch. Squeeze at top.", rest: 60 },
      { name: "Deficit Reverse Lunge", sets: 3, repsLow: 10, repsHigh: 10, tempo: "3-0-1-0", defaultWeight: 40, note: "Each leg. Stand on step for extra ROM.", rest: 60 },
      { name: "Calf Raise (both legs)", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-2-1-2", defaultWeight: 50, note: "Hold at top and bottom. Per hand.", rest: 60 },
    ],
  },
  "Upper B": {
    subtitle: "Pull Focus",
    exercises: [
      { name: "Single Arm DB Row", sets: 4, repsLow: 8, repsHigh: 10, tempo: "2-1-1-2", defaultWeight: 50, note: "Each arm. 2-sec squeeze at top.", rest: 90 },
      { name: "Chest-Supported Row", sets: 3, repsLow: 10, repsHigh: 12, tempo: "2-1-1-1", defaultWeight: 40, note: "Lie face down on angled surface. Per hand.", rest: 90 },
      { name: "DB Pullover", sets: 3, repsLow: 12, repsHigh: 15, tempo: "3-0-1-1", defaultWeight: 40, note: "Slight elbow bend. Deep stretch.", rest: 60 },
      { name: "Seated Alternating Curl", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-0-1-1", defaultWeight: 27, note: "Each arm. Seated removes momentum.", rest: 60 },
      { name: "Hammer Curl to Press", sets: 3, repsLow: 10, repsHigh: 10, tempo: "Controlled", defaultWeight: 27, note: "Curl up, press overhead, lower.", rest: 60 },
    ],
  },
  "Day 5": {
    subtitle: "Arms, Shoulders, Abs (Optional)",
    exercises: [
      { name: "Concentration Curl", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-0-1-1", defaultWeight: 25, note: "Each arm. Elbow braced on inner thigh.", rest: 60 },
      { name: "Tricep Kickback", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-1-1-0", defaultWeight: 20, note: "Each arm. Full extension, squeeze.", rest: 60 },
      { name: "Arnold Press", sets: 3, repsLow: 10, repsHigh: 12, tempo: "Controlled", defaultWeight: 30, note: "Rotation through the press.", rest: 60 },
      { name: "Reverse Fly", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-1-2-0", defaultWeight: 17, note: "Bent over. Rear delts.", rest: 60 },
      { name: "Lying Leg Raise", sets: 3, repsLow: 15, repsHigh: 20, tempo: "Controlled", defaultWeight: 0, note: "Slow and controlled.", rest: 45 },
    ],
  },
};

const DAYS_ORDER = ["Lower A", "Upper A", "Lower B", "Upper B", "Day 5"];
const WEEK_SCHEDULE = { Sat: "Lower A", Sun: "Upper A", Mon: null, Tue: "Lower B", Wed: null, Thu: "Upper B", Fri: "Day 5" };
const TECHNIQUES = ["Standard", "1.5 Reps", "Pause Reps", "Rest-Pause", "Mech. Drop Set", "Slow Tempo (+1s)"];
const CHECKLIST_ITEMS = [
  "Hit all 4 scheduled sessions (5 if including optional day)",
  "Improved at least 2 exercises (more reps, sets, tempo, or technique)",
  "Hit 150g+ protein on at least 5 of 7 days",
  "No exercises felt 'easy' by the final set",
  "Logged every session with weight, reps, sets, and tempo",
];

let state = { view: "home", activeDay: null, workoutData: {}, history: {}, checklist: {}, restTimer: null, restTimeLeft: 0, restInterval: null, restDuration: 0, lastExportDate: null, backupDismissDate: null, syncKey: null, syncEnabled: true, lastSyncedAt: null, syncStatus: 'idle', needsSync: false };
let syncDebounceTimer = null;

function getToday() { return new Date().toISOString().split("T")[0]; }
function getDayName() { return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date().getDay()]; }
function getWeekId(d) {
  const date = new Date(d); date.setHours(0,0,0,0);
  const dayNum = date.getDay() || 7;
  date.setDate(date.getDate() + 4 - dayNum);
  const yearStart = new Date(date.getFullYear(), 0, 1);
  const weekNo = Math.ceil(((date - yearStart) / 86400000 + 1) / 7);
  return `${date.getFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

function loadData() {
  try {
    const raw = localStorage.getItem("ironlog-data");
    if (!raw) {
      // Try IndexedDB fallback
      loadFromIDB().then(idbData => {
        if (idbData) {
          state.history = idbData.history || {};
          state.checklist = idbData.checklist || {};
          state.lastExportDate = idbData.lastExportDate || null;
          state.backupDismissDate = idbData.backupDismissDate || null;
          saveData(); render();
          showToast('Recovered data from backup', 'success');
        }
      });
      return;
    }
    const p = JSON.parse(raw);
    if (!p.version) {
      localStorage.setItem("ironlog-data-v1-backup", raw);
      state.history = p.history || {};
      state.checklist = p.checklist || {};
      state.lastExportDate = null;
      state.backupDismissDate = null;
      saveData();
    } else if (p.version === 2) {
      state.history = p.history || {};
      state.checklist = p.checklist || {};
      state.lastExportDate = p.lastExportDate || null;
      state.backupDismissDate = p.backupDismissDate || null;
    } else {
      console.warn("Unknown data version:", p.version);
    }
  } catch(e) { console.log("No data yet"); }
  // Load sync settings
  try {
    const sync = localStorage.getItem("ironlog-sync");
    if (sync) {
      const s = JSON.parse(sync);
      state.syncKey = s.syncKey || null;
      state.syncEnabled = s.syncEnabled !== false;
      state.lastSyncedAt = s.lastSyncedAt || null;
    }
  } catch(e) { /* no sync config */ }
}

function saveData() {
  const payload = { version: 2, history: state.history, checklist: state.checklist, lastExportDate: state.lastExportDate, backupDismissDate: state.backupDismissDate };
  try { localStorage.setItem("ironlog-data", JSON.stringify(payload)); } catch(e) { console.error(e); showToast('Storage full ‚Äî backup only', 'error'); }
  saveToIDB(payload);
  debouncedSync();
}

function saveSyncSettings() {
  try { localStorage.setItem("ironlog-sync", JSON.stringify({ syncKey: state.syncKey, syncEnabled: state.syncEnabled, lastSyncedAt: state.lastSyncedAt })); } catch(e) { /* */ }
}

function getLastVal(dayName, exIndex, field) {
  const dates = Object.keys(state.history).sort().reverse();
  for (const d of dates) { if (state.history[d]?.[dayName]?.[exIndex]) return state.history[d][dayName][exIndex][field]; }
  return null;
}

function getLastReps(dayName, exIndex, setIndex) {
  const dates = Object.keys(state.history).sort().reverse();
  for (const d of dates) { const s = state.history[d]?.[dayName]?.[exIndex]?.sets?.[setIndex]; if (s) return s.reps; }
  return null;
}

function getWeekSessions() {
  const wid = getWeekId(new Date()); let c = 0;
  Object.keys(state.history).forEach(d => { if (getWeekId(d) === wid) c += Object.keys(state.history[d]).length; });
  return c;
}

function startWorkout(dayName) {
  const prog = PROGRAM[dayName]; const today = getToday();
  if (state.history[today]?.[dayName]) { state.workoutData = JSON.parse(JSON.stringify(state.history[today][dayName])); }
  else {
    const data = {};
    prog.exercises.forEach((ex, i) => {
      data[i] = { weight: getLastVal(dayName, i, "weight") || ex.defaultWeight, technique: getLastVal(dayName, i, "technique") || "Standard",
        sets: Array.from({length: ex.sets}, (_, si) => ({ reps: getLastReps(dayName, i, si) || ex.repsLow, completed: false })), notes: "" };
    });
    state.workoutData = data;
  }
  state.activeDay = dayName; state.view = "workout"; render();
}

function finishWorkout() {
  const today = getToday();
  if (!state.history[today]) state.history[today] = {};
  state.history[today][state.activeDay] = JSON.parse(JSON.stringify(state.workoutData));
  saveData(); state.view = "home"; state.activeDay = null; state.workoutData = {}; stopRest(); render();
}

function renderTimer() {
  const el = document.getElementById("rest-timer");
  if (state.restTimeLeft > 0) {
    el.innerHTML = `<div class="rest-pill"><span class="rest-label">REST</span><span class="rest-time">${state.restTimeLeft}s</span><button class="btn-skip" onclick="stopRest()">Skip</button></div>`;
  } else {
    el.innerHTML = "";
  }
  document.getElementById("app").classList.toggle("timer-active", state.restTimeLeft > 0);
}

function startRest(seconds) {
  stopRest(); state.restTimeLeft = seconds; state.restDuration = seconds;
  state.restInterval = setInterval(() => {
    state.restTimeLeft--;
    if (state.restTimeLeft <= 0) { stopRest(); return; }
    renderTimer();
  }, 1000);
  renderTimer();
}

function stopRest() { if (state.restInterval) clearInterval(state.restInterval); state.restInterval = null; state.restTimeLeft = 0; state.restDuration = 0; renderTimer(); }

function toggleChecklist(i) {
  const wid = getWeekId(new Date()); const cur = state.checklist[wid] || [];
  state.checklist[wid] = cur.includes(i) ? cur.filter(x => x !== i) : [...cur, i];
  saveData(); render();
}


function getDataStats() {
  const dates = Object.keys(state.history);
  let exerciseEntries = 0;
  dates.forEach(d => Object.values(state.history[d]).forEach(day => { exerciseEntries += Object.keys(day).length; }));
  return { sessions: dates.length, exerciseEntries };
}

function buildExportPayload() {
  const dates = Object.keys(state.history).sort();
  return {
    version: 2,
    appVersion: "Iron Log v2",
    exportDate: new Date().toISOString(),
    totalSessions: dates.length,
    dateRange: dates.length > 0 ? { earliest: dates[0], latest: dates[dates.length - 1] } : null,
    history: state.history,
    checklist: state.checklist,
  };
}

function exportData() {
  const payload = buildExportPayload();
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ironlog-backup-" + getToday() + ".json";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  state.lastExportDate = new Date().toISOString();
  saveData(); render();
}

function copyDataToClipboard() {
  const payload = buildExportPayload();
  try {
    navigator.clipboard.writeText(JSON.stringify(payload, null, 2)).then(() => {
      alert("Data copied to clipboard!");
    }).catch(() => {
      alert("Clipboard not available. Use the download option instead.");
    });
  } catch(e) {
    alert("Clipboard not available. Use the download option instead.");
  }
}

function importData() {
  const input = document.createElement("input");
  input.type = "file"; input.accept = ".json";
  input.onchange = (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const imported = JSON.parse(ev.target.result);
        if (!imported.history || typeof imported.history !== "object") { alert("Invalid file: no history data found."); return; }
        if (imported.version && imported.version > 2) { alert("This backup was created by a newer version of Iron Log. Please update the app first."); return; }
        const importDates = Object.keys(imported.history);
        const existingDates = Object.keys(state.history);
        const overlap = importDates.filter(d => existingDates.includes(d));
        const newDates = importDates.filter(d => !existingDates.includes(d));
        const summary = `Import Summary:\n‚Ä¢ ${importDates.length} total dates in file\n‚Ä¢ ${newDates.length} new dates\n‚Ä¢ ${overlap.length} overlapping dates\n\nProceed with import?`;
        if (!confirm(summary)) return;
        if (overlap.length > 0) {
          if (confirm("Overlapping dates found. OK = Merge (import overwrites conflicts), Cancel = Replace all data")) {
            overlap.forEach(d => { state.history[d] = { ...state.history[d], ...imported.history[d] }; });
            newDates.forEach(d => { state.history[d] = imported.history[d]; });
            if (imported.checklist) { Object.keys(imported.checklist).forEach(k => { state.checklist[k] = imported.checklist[k]; }); }
          } else {
            if (confirm("Replace ALL existing data with imported data? This cannot be undone.")) {
              state.history = imported.history;
              state.checklist = imported.checklist || {};
            } else { return; }
          }
        } else {
          newDates.forEach(d => { state.history[d] = imported.history[d]; });
          if (imported.checklist) { Object.keys(imported.checklist).forEach(k => { state.checklist[k] = imported.checklist[k]; }); }
        }
        saveData(); render();
        alert("Import complete!");
      } catch(err) { alert("Failed to parse file. Make sure it's a valid Iron Log backup."); }
    };
    reader.readAsText(file);
  };
  input.click();
}


function dismissBackupReminder() {
  state.backupDismissDate = new Date().toISOString();
  saveData(); render();
}

function getProgressData(dayName, exIndex) {
  const entries = [];
  Object.keys(state.history).sort().forEach(date => {
    const ex = state.history[date]?.[dayName]?.[exIndex];
    if (ex) { entries.push({ date, weight: ex.weight, totalReps: ex.sets.reduce((s,x) => s + (x.reps||0), 0), technique: ex.technique, numSets: ex.sets.length }); }
  });
  return entries;
}

// ===== INDEXEDDB BACKUP =====
function openIDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('ironlog-backup', 1);
    req.onupgradeneeded = () => req.result.createObjectStore('data');
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function saveToIDB(data) {
  openIDB().then(db => {
    const tx = db.transaction('data', 'readwrite');
    tx.objectStore('data').put(data, 'current');
  }).catch(() => { /* IDB unavailable ‚Äî localStorage is primary */ });
}

function loadFromIDB() {
  return openIDB().then(db => {
    return new Promise((resolve) => {
      const tx = db.transaction('data', 'readonly');
      const req = tx.objectStore('data').get('current');
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => resolve(null);
    });
  }).catch(() => null);
}

// ===== TOAST =====
let toastTimer = null;
function showToast(message, type) {
  const el = document.getElementById('toast');
  if (!el) return;
  const pill = document.createElement('div');
  pill.className = 'toast-pill ' + (type || '');
  pill.textContent = message;
  el.replaceChildren(pill);
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.classList.remove('show'); }, 2500);
}

// ===== CLOUD SYNC =====
function canSync() {
  return SYNC_WORKER_URL && state.syncKey && state.syncKey.length >= 8 && state.syncEnabled;
}

function debouncedSync() {
  if (!canSync() || state.syncStatus === 'syncing') return;
  clearTimeout(syncDebounceTimer);
  syncDebounceTimer = setTimeout(() => syncToCloud(), SYNC_DEBOUNCE_MS);
}

async function syncToCloud() {
  if (!canSync() || !navigator.onLine) {
    state.needsSync = true;
    state.syncStatus = navigator.onLine ? 'idle' : 'offline';
    return;
  }
  state.syncStatus = 'syncing';
  if (state.view === 'settings') render();

  try {
    const payload = { version: 2, history: state.history, checklist: state.checklist, lastExportDate: state.lastExportDate, backupDismissDate: state.backupDismissDate };
    const resp = await fetch(SYNC_WORKER_URL + '/sync?key=' + encodeURIComponent(state.syncKey), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error || 'HTTP ' + resp.status);
    }

    const result = await resp.json();
    state.lastSyncedAt = result.serverUpdatedAt || new Date().toISOString();
    state.syncStatus = 'synced';
    state.needsSync = false;
    saveSyncSettings();
    showToast('Synced', 'success');
  } catch (e) {
    console.error('Sync push failed:', e);
    state.syncStatus = 'error';
    state.needsSync = true;
    showToast('Sync failed ‚Äî will retry', 'error');
  }
  if (state.view === 'settings') render();
}

async function pullFromCloud() {
  if (!canSync() || !navigator.onLine) return;
  state.syncStatus = 'syncing';
  if (state.view === 'settings') render();

  try {
    const resp = await fetch(SYNC_WORKER_URL + '/sync?key=' + encodeURIComponent(state.syncKey));
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const result = await resp.json();

    if (!result.exists) {
      // No cloud data ‚Äî push local to create it
      await syncToCloud();
      return;
    }

    const cloud = result.data;
    const localDates = Object.keys(state.history);
    const isLocalEmpty = localDates.length === 0;
    const isFirstSync = !state.lastSyncedAt;

    if (isFirstSync && !isLocalEmpty) {
      // Both have data on first sync ‚Äî ask user
      const cloudDates = Object.keys(cloud.history || {});
      if (cloudDates.length > 0) {
        const choice = confirm('Found ' + cloudDates.length + ' session(s) in cloud and ' + localDates.length + ' locally.\n\nOK = Load cloud data\nCancel = Keep this device\'s data and push to cloud');
        if (choice) {
          applyCloudData(cloud);
        } else {
          await syncToCloud();
        }
        return;
      }
    }

    if (isLocalEmpty && result.exists) {
      // New device ‚Äî pull cloud data
      applyCloudData(cloud);
      showToast('Loaded data from cloud', 'success');
      return;
    }

    // Normal sync ‚Äî compare timestamps
    if (state.lastSyncedAt && result.serverUpdatedAt > state.lastSyncedAt) {
      applyCloudData(cloud);
    } else {
      // Local is same or newer ‚Äî push
      await syncToCloud();
    }
  } catch (e) {
    console.error('Sync pull failed:', e);
    state.syncStatus = 'error';
    showToast('Sync failed', 'error');
  }
  if (state.view === 'settings') render();
}

function applyCloudData(cloud) {
  state.history = cloud.history || {};
  state.checklist = cloud.checklist || {};
  state.lastExportDate = cloud.lastExportDate || state.lastExportDate;
  state.backupDismissDate = cloud.backupDismissDate || state.backupDismissDate;
  state.lastSyncedAt = new Date().toISOString();
  state.syncStatus = 'synced';
  state.needsSync = false;
  saveData();
  saveSyncSettings();
  render();
}

function setSyncKey(key) {
  if (key && key.length < 8) {
    showToast('Key must be at least 8 characters', 'error');
    return;
  }
  if (state.syncKey && key !== state.syncKey) {
    if (!confirm('Changing your sync key will disconnect from your existing cloud data. Continue?')) return;
  }
  state.syncKey = key || null;
  state.lastSyncedAt = null;
  saveSyncSettings();
  if (key) pullFromCloud();
  render();
}

function toggleSync() {
  state.syncEnabled = !state.syncEnabled;
  saveSyncSettings();
  if (state.syncEnabled && canSync()) pullFromCloud();
  render();
}

function formatTimeAgo(isoStr) {
  if (!isoStr) return 'Never';
  const diff = Date.now() - new Date(isoStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hours = Math.floor(mins / 60);
  if (hours < 24) return hours + 'h ago';
  const days = Math.floor(hours / 24);
  return days + 'd ago';
}

function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }

function renderHome() {
  const day = getDayName(); const suggested = WEEK_SCHEDULE[day]; const ws = getWeekSessions();
  const wid = getWeekId(new Date()); const checked = state.checklist[wid] || [];
  const today = getToday();

  let todayHTML = "";
  if (suggested) {
    const hasDone = state.history[today]?.[suggested];
    todayHTML = `<div class="today-card">
      <div class="label">TODAY ‚Äî ${day.toUpperCase()}</div>
      <h2>${suggested}</h2>
      <div class="sub">${PROGRAM[suggested].subtitle}</div>
      <button class="btn-primary" onclick="startWorkout('${suggested}')">${hasDone ? "Continue Workout ‚Üí" : "Start Workout ‚Üí"}</button>
    </div>`;
  } else {
    todayHTML = `<div class="rest-day-card"><h2>Rest Day</h2><p>Recover. Eat protein. Come back stronger.</p></div>`;
  }

  let dayCards = DAYS_ORDER.map(d => {
    const done = state.history[today]?.[d];
    return `<button class="day-card${done ? ' done' : ''}" onclick="startWorkout('${d}')">
      <span class="name">${d}</span><span class="sub">${PROGRAM[d].subtitle}</span>${done ? '<span class="done-label">‚úì Done</span>' : ''}
    </button>`;
  }).join("");

  let checklistHTML = CHECKLIST_ITEMS.map((item, i) => {
    const c = checked.includes(i);
    return `<button class="checklist-row" onclick="toggleChecklist(${i})">
      <span class="checkbox${c ? ' checked' : ''}">${c ? '‚úì' : ''}</span>
      <span class="checklist-text${c ? ' checked' : ''}">${esc(item)}</span>
    </button>`;
  }).join("");

  let backupHTML = "";
  if (needsBackupReminder()) {
    backupHTML = `<div class="backup-reminder" onclick="state.view='settings';render()">
      <div class="msg"><div class="title">Back up your data</div><div class="sub">Tap to export your workout history</div></div>
      <button class="backup-dismiss" onclick="event.stopPropagation();dismissBackupReminder()">√ó</button>
    </div>`;
  }

  return `
    <div class="header">
      <div><h1>IRON LOG</h1><div class="sub">Dumbbell Hypertrophy Program</div></div>
      <div style="display:flex;gap:10px;align-items:flex-start"><div class="week-badge"><span class="num">${ws}</span><span class="label">this week</span></div><button class="gear-btn" onclick="state.view='settings';render()">‚öô</button></div>
    </div>
    ${todayHTML}
    ${backupHTML}
    <div class="section"><div class="section-title">All Workouts</div><div class="day-grid">${dayCards}</div></div>
    <div class="section"><div class="section-title">Weekly Checklist</div>${checklistHTML}<div class="checklist-score">${checked.length}/5 this week</div></div>
    <div class="nav-bar">
      <button class="nav-btn" onclick="state.view='history';render()"><span class="icon">üìã</span><span class="label">History</span></button>
      <button class="nav-btn" onclick="state.view='progress';render()"><span class="icon">üìà</span><span class="label">Progress</span></button>
    </div>`;
}

function renderWorkout() {
  const prog = PROGRAM[state.activeDay]; const data = state.workoutData;

  let exercises = prog.exercises.map((ex, i) => {
    const d = data[i]; if (!d) return "";
    const allDone = d.sets.every(s => s.completed);

    let setsHTML = d.sets.map((s, si) => {
      return `<div class="set-row${s.completed ? ' done' : ''}">
        <span class="set-label">Set ${si+1}</span>
        <div class="number-input">
          <button class="num-btn-sm" onclick="state.workoutData[${i}].sets[${si}].reps=Math.max(0,state.workoutData[${i}].sets[${si}].reps-1);render()">‚àí</button>
          <span class="num-value-sm">${s.reps}</span>
          <button class="num-btn-sm" onclick="state.workoutData[${i}].sets[${si}].reps++;render()">+</button>
        </div>
        <span class="reps-label">reps</span>
        ${!s.completed ? `<button class="btn-done" onclick="state.workoutData[${i}].sets[${si}].completed=true;startRest(${ex.rest});render()">Done</button>` : '<span class="done-check">‚úì</span>'}
      </div>`;
    }).join("");

    let techOptions = TECHNIQUES.map(t => `<option value="${t}"${d.technique === t ? ' selected' : ''}>${t}</option>`).join("");

    return `<div class="exercise-card${allDone ? ' completed' : ''}">
      <div class="ex-header"><div>
        <div class="ex-name">${esc(ex.name)}</div>
        <div class="ex-meta">${ex.sets}√ó${ex.repsLow}${ex.repsLow !== ex.repsHigh ? '‚Äì'+ex.repsHigh : ''} ¬∑ ${ex.tempo} ¬∑ Rest ${ex.rest}s</div>
        <div class="ex-note">${esc(ex.note)}</div>
      </div>${allDone ? '<span class="ex-check">‚úì</span>' : ''}</div>
      <div class="controls-row">
        <div class="control-group"><label class="control-label">Weight (lbs)</label>
          <div class="number-input">
            <button class="num-btn" onclick="state.workoutData[${i}].weight=Math.max(0,state.workoutData[${i}].weight-5);render()">‚àí</button>
            <span class="num-value">${d.weight}</span>
            <button class="num-btn" onclick="state.workoutData[${i}].weight+=5;render()">+</button>
          </div>
        </div>
        <div class="control-group"><label class="control-label">Technique</label>
          <select class="technique-select" onchange="state.workoutData[${i}].technique=this.value;render()">${techOptions}</select>
        </div>
      </div>
      <div class="sets-container">${setsHTML}</div>
      <input class="notes-input" placeholder="Notes..." value="${esc(d.notes || '')}" oninput="state.workoutData[${i}].notes=this.value">
    </div>`;
  }).join("");

  return `
    <div class="workout-header">
      <button class="btn-outline" onclick="if(confirm('Save and exit?'))finishWorkout()">‚Üê Back</button>
      <div class="center"><h1>${state.activeDay}</h1><p>${prog.subtitle}</p></div>
      <button class="btn-finish" onclick="finishWorkout()">Finish ‚úì</button>
    </div>
    <div class="exercise-list">${exercises}</div>
    <button class="btn-finish-lg" onclick="finishWorkout()">Complete Workout ‚úì</button>`;
}

function renderHistory() {
  const dates = Object.keys(state.history).sort().reverse();
  let content = "";
  if (dates.length === 0) { content = '<p class="empty-text">No workouts logged yet. Get after it.</p>'; }
  else {
    content = dates.map(date => {
      const dateStr = new Date(date + "T12:00:00").toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" });
      let cards = Object.entries(state.history[date]).map(([dayName, exercises]) => {
        let rows = PROGRAM[dayName]?.exercises.map((ex, i) => {
          const d = exercises[i]; if (!d) return "";
          const reps = d.sets.map(s => s.reps).join("/");
          const tech = d.technique !== "Standard" ? ` ¬∑ ${d.technique}` : "";
          return `<div class="history-ex-row"><span class="history-ex-name">${esc(ex.name)}</span><span class="history-ex-detail">${d.weight}lbs ¬∑ ${reps}${tech}</span></div>`;
        }).join("") || "";
        return `<div class="history-card"><div class="history-day-name">${dayName} ‚Äî ${PROGRAM[dayName]?.subtitle || ''}</div>${rows}</div>`;
      }).join("");
      return `<div class="history-block"><div class="history-date">${dateStr}</div>${cards}</div>`;
    }).join("");
  }

  return `
    <div class="nav-row">
      <button class="btn-outline" onclick="state.view='home';render()">‚Üê Back</button>
      <span class="page-title">History</span><div style="width:60px"></div>
    </div>
    ${content}`;
}

function renderProgress() {
  let content = "";
  let hasAny = false;

  DAYS_ORDER.forEach(dayName => {
    const prog = PROGRAM[dayName];
    let rows = "";
    let dayHasData = false;

    prog.exercises.forEach((ex, i) => {
      const data = getProgressData(dayName, i);
      if (data.length === 0) return;
      dayHasData = true; hasAny = true;
      const latest = data[data.length - 1]; const first = data[0];
      const rd = latest.totalReps - first.totalReps; const wd = latest.weight - first.weight;
      let wdHTML = wd !== 0 ? `<span class="progress-diff ${wd > 0 ? 'up' : 'down'}">${wd > 0 ? '+' : ''}${wd}</span>` : '';
      let rdHTML = rd !== 0 ? `<span class="progress-diff ${rd > 0 ? 'up' : 'down'}">${rd > 0 ? '+' : ''}${rd}</span>` : '';

      rows += `<div class="progress-ex-row">
        <div class="progress-ex-name">${esc(ex.name)}</div>
        <div class="progress-stats"><span class="progress-stat">${latest.weight}lbs</span>${wdHTML}<span class="progress-sep">¬∑</span><span class="progress-stat">${latest.totalReps} total reps</span>${rdHTML}</div>
        <div class="progress-sessions">${data.length} session${data.length > 1 ? 's' : ''}</div>
      </div>`;
    });

    if (dayHasData) { content += `<div class="progress-block"><div class="progress-day-title">${dayName} ‚Äî ${prog.subtitle}</div>${rows}</div>`; }
  });

  if (!hasAny) content = '<p class="empty-text">Complete some workouts to see your progress.</p>';

  return `
    <div class="nav-row">
      <button class="btn-outline" onclick="state.view='home';render()">‚Üê Back</button>
      <span class="page-title">Progress</span><div style="width:60px"></div>
    </div>
    ${content}`;
}

function renderSettings() {
  const stats = getDataStats();
  const lastExport = state.lastExportDate ? new Date(state.lastExportDate).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }) : "Never";

  // Sync section
  let syncHTML = '';
  if (!SYNC_WORKER_URL) {
    syncHTML = '<div class="settings-section"><div class="settings-section-title">Cloud Sync</div><div class="settings-row"><div class="info"><div class="title" style="color:#64748b">Not configured</div><div class="sub">Set SYNC_WORKER_URL to enable cloud sync</div></div></div></div>';
  } else if (!state.syncKey) {
    syncHTML = `<div class="settings-section">
      <div class="settings-section-title">Cloud Sync</div>
      <div style="background:#1e293b;border:1px solid #334155;border-radius:10px;padding:16px">
        <div style="font-size:13px;color:#e2e8f0;font-weight:600;margin-bottom:4px">Set up sync</div>
        <div style="font-size:11px;color:#64748b;margin-bottom:12px">Enter a passphrase to sync across devices. Use the same key on all devices.</div>
        <div class="sync-key-row">
          <input class="sync-key-input" id="sync-key-input" type="password" placeholder="Enter sync key (min 8 chars)" minlength="8">
          <button class="settings-btn primary" onclick="setSyncKey(document.getElementById('sync-key-input').value)">Save</button>
        </div>
      </div>
    </div>`;
  } else {
    const statusClass = state.syncStatus === 'synced' ? 'synced' : state.syncStatus === 'syncing' ? 'syncing' : state.syncStatus === 'error' ? 'error' : state.syncStatus === 'offline' ? 'offline' : 'synced';
    const statusLabel = state.syncStatus === 'synced' ? 'Synced' : state.syncStatus === 'syncing' ? 'Syncing...' : state.syncStatus === 'error' ? 'Error' : state.syncStatus === 'offline' ? 'Offline' : 'Ready';
    syncHTML = `<div class="settings-section">
      <div class="settings-section-title">Cloud Sync</div>
      <div class="settings-row">
        <div class="info">
          <div class="title">Status</div>
          <div style="margin-top:6px"><span class="sync-status-badge ${statusClass}"><span class="dot"></span>${esc(statusLabel)}</span></div>
          <div class="sync-meta">Last synced: ${esc(formatTimeAgo(state.lastSyncedAt))}</div>
        </div>
        <button class="settings-btn primary" onclick="pullFromCloud()">Sync Now</button>
      </div>
      <div class="settings-row">
        <div class="info"><div class="title">Sync Key</div><div class="sub" id="sync-key-display" style="font-family:monospace">${state.syncKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'Not set'}</div></div>
        <button class="settings-btn" onclick="const el=document.getElementById('sync-key-display');el.textContent=el.textContent==='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'?state.syncKey:'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'">Show</button>
      </div>
      <div class="settings-row">
        <div class="info"><div class="title">Change Sync Key</div><div class="sub">Disconnect and use a different key</div></div>
        <button class="settings-btn" onclick="setSyncKey(prompt('Enter new sync key (min 8 chars):'))">Change</button>
      </div>
      <div class="settings-row">
        <div class="info"><div class="title">${state.syncEnabled ? 'Sync Enabled' : 'Sync Disabled'}</div><div class="sub">Toggle automatic cloud sync</div></div>
        <button class="settings-btn${state.syncEnabled ? '' : ' primary'}" onclick="toggleSync()">${state.syncEnabled ? 'Disable' : 'Enable'}</button>
      </div>
    </div>`;
  }

  return `
    <div class="nav-row">
      <button class="btn-outline" onclick="state.view='home';render()">‚Üê Back</button>
      <span class="page-title">Settings</span><div style="width:60px"></div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Data Summary</div>
      <div class="settings-stats">
        <div class="settings-stat"><div class="num">${stats.sessions}</div><div class="label">Sessions</div></div>
        <div class="settings-stat"><div class="num">${stats.exerciseEntries}</div><div class="label">Exercises</div></div>
      </div>
    </div>
    ${syncHTML}
    <div class="settings-section">
      <div class="settings-section-title">Export</div>
      <div class="settings-row">
        <div class="info"><div class="title">Download Backup</div><div class="sub">Last export: ${esc(lastExport)}</div></div>
        <button class="settings-btn primary" onclick="exportData()">Download</button>
      </div>
      <div class="settings-row">
        <div class="info"><div class="title">Copy to Clipboard</div><div class="sub">Copy JSON data to clipboard</div></div>
        <button class="settings-btn" onclick="copyDataToClipboard()">Copy</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Import</div>
      <div class="settings-row">
        <div class="info"><div class="title">Import Backup</div><div class="sub">Load a previously exported JSON file</div></div>
        <button class="settings-btn" onclick="importData()">Import</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">App</div>
      <div class="settings-row">
        <div class="info"><div class="title">Check for Updates</div><div class="sub">Check if a new version is available</div></div>
        <button class="settings-btn" onclick="checkForUpdates()">Check</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Danger Zone</div>
      <div class="settings-row">
        <div class="info"><div class="title" style="color:#f87171">Reset All Data</div><div class="sub">Permanently delete all workout history</div></div>
        <button class="settings-btn danger" onclick="resetData()">Reset</button>
      </div>
    </div>`;
}

function render() {
  const app = document.getElementById("app");
  switch (state.view) {
    case "home": app.innerHTML = renderHome(); break;
    case "workout": app.innerHTML = renderWorkout(); break;
    case "history": app.innerHTML = renderHistory(); break;
    case "progress": app.innerHTML = renderProgress(); break;
    case "settings": app.innerHTML = renderSettings(); break;
  }
}

// ===== BACKUP REMINDER (cloud-aware) =====
function needsBackupReminder() {
  if (Object.keys(state.history).length === 0) return false;
  // If cloud sync active and recent, suppress reminder
  if (canSync() && state.lastSyncedAt) {
    const sinceLast = Date.now() - new Date(state.lastSyncedAt).getTime();
    if (sinceLast < 24 * 60 * 60 * 1000) return false;
    // Sync stalled ‚Äî show different warning (handled in render)
  }
  if (state.backupDismissDate) {
    const dismissed = new Date(state.backupDismissDate);
    if ((new Date() - dismissed) < 7 * 24 * 60 * 60 * 1000) return false;
  }
  if (!state.lastExportDate) return true;
  return (new Date() - new Date(state.lastExportDate)) > 14 * 24 * 60 * 60 * 1000;
}

// ===== AUTO-EXPORT BEFORE RESET =====
function resetData() {
  if (confirm("This will permanently delete ALL workout history. Are you sure?")) {
    if (confirm("This CANNOT be undone. A backup will be downloaded first. Proceed?")) {
      exportData(); // Auto-download backup
      localStorage.removeItem("ironlog-data"); state.history = {}; state.checklist = {}; state.lastExportDate = null; state.backupDismissDate = null; render();
    }
  }
}

// ===== SERVICE WORKER UPDATE CHECK =====
function checkForUpdates() {
  if (!('serviceWorker' in navigator)) {
    showToast('Service worker not supported', 'error');
    return;
  }
  navigator.serviceWorker.getRegistration().then(reg => {
    if (!reg) { showToast('No service worker registered', 'error'); return; }
    reg.update().then(() => {
      if (reg.waiting) {
        showToast('Update available ‚Äî reloading...', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast('Already up to date', 'success');
      }
    });
  }).catch(() => showToast('Update check failed', 'error'));
}

// ===== FILE PROTOCOL BANNER =====
function checkFileProtocol() {
  if (location.protocol === 'file:') {
    const banner = document.getElementById('file-banner');
    if (banner) {
      banner.className = 'file-banner';
      banner.textContent = 'You\'re viewing the local file. For sync and offline support, use the hosted version.';
    }
  }
}

// ===== ONLINE/OFFLINE LISTENERS =====
window.addEventListener('online', () => {
  if (state.needsSync && canSync()) syncToCloud();
  showToast('Back online', 'success');
});

window.addEventListener('offline', () => {
  state.syncStatus = 'offline';
  showToast('Offline ‚Äî changes saved locally', '');
});

// ===== SERVICE WORKER REGISTRATION =====
if ('serviceWorker' in navigator && location.protocol !== 'file:') {
  navigator.serviceWorker.register('sw.js').then(reg => {
    // Listen for new SW waiting
    reg.addEventListener('updatefound', () => {
      const newSW = reg.installing;
      if (newSW) {
        newSW.addEventListener('statechange', () => {
          if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
            showToast('Update available ‚Äî check Settings', 'success');
          }
        });
      }
    });
  }).catch(err => console.error('SW registration failed:', err));
}

// ===== STARTUP =====
loadData();
render();
checkFileProtocol();

// Initial cloud pull (on startup, if configured)
if (canSync() && navigator.onLine) {
  setTimeout(() => pullFromCloud(), 500);
}
</script>
</body>
</html>
