<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Iron Log">
<meta name="theme-color" content="#0f172a">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<title>IRON LOG</title>
<script>
  // Apply theme before CSS parses to prevent flash of wrong theme
  (function(){
    var t = localStorage.getItem('ironlog-theme') || 'system';
    if (t === 'system') t = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', t);
  })();
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');

  /* ===== THEME VARIABLES =====
     Theme is applied via data-theme="dark|light" on <html>.
     FOUC prevention: inline <script> in <head> sets data-theme before CSS parses.
     To add a new themed color: add a variable in both [data-theme] blocks,
     then use var(--name) in the CSS rule. */

  [data-theme="dark"] {
    color-scheme: dark;

    --bg-base: #0f172a;
    --bg-surface: #1e293b;
    --bg-elevated: #334155;
    --bg-pressed: #475569;

    --text-primary: #e2e8f0;
    --text-heading: #f8fafc;
    --text-title: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-muted: #94a3b8;
    --text-dim: #64748b;

    --border-default: #334155;
    --border-subtle: #1e293b;
    --border-strong: #475569;

    --accent: #4ade80;
    --accent-pressed: #22c55e;
    --accent-border: #22543d;
    --accent-bg: #14532d;
    --accent-bg-dark: #0f2a1e;
    --on-accent: #0f172a;

    --danger: #f87171;
    --danger-border: #7f1d1d;
    --danger-bg: #450a0a;

    --warning: #fb923c;

    --timer-bg: rgba(124,45,18,0.92);
    --timer-label: #fed7aa;
    --timer-time: #fb923c;

    --toast-bg: rgba(30,41,59,0.95);

    --badge-syncing-bg: #1e3a5f;
    --badge-syncing-text: #60a5fa;
    --badge-offline-bg: #3f3f46;
    --badge-offline-text: #a1a1aa;

    --backup-gradient-start: #7c2d12;
    --backup-gradient-end: #92400e;
    --backup-border: #b45309;
    --backup-title: #fed7aa;
    --backup-sub: #fbbf24;

    --banner-bg: #92400e;
    --banner-text: #fef3c7;
    --banner-link: #fbbf24;

    --checkbox-border: #475569;
    --checkbox-check-text: #0f172a;
  }

  [data-theme="light"] {
    color-scheme: light;

    --bg-base: #f1f5f9;
    --bg-surface: #ffffff;
    --bg-elevated: #e2e8f0;
    --bg-pressed: #cbd5e1;

    --text-primary: #1e293b;
    --text-heading: #0f172a;
    --text-title: #1e293b;
    --text-secondary: #334155;
    --text-muted: #64748b;
    --text-dim: #94a3b8;

    --border-default: #cbd5e1;
    --border-subtle: #e2e8f0;
    --border-strong: #94a3b8;

    --accent: #16a34a;
    --accent-pressed: #15803d;
    --accent-border: #86efac;
    --accent-bg: #dcfce7;
    --accent-bg-dark: #bbf7d0;
    --on-accent: #ffffff;

    --danger: #dc2626;
    --danger-border: #fca5a5;
    --danger-bg: #fee2e2;

    --warning: #ea580c;

    --timer-bg: rgba(254,215,170,0.95);
    --timer-label: #9a3412;
    --timer-time: #c2410c;

    --toast-bg: rgba(255,255,255,0.95);

    --badge-syncing-bg: #dbeafe;
    --badge-syncing-text: #2563eb;
    --badge-offline-bg: #e4e4e7;
    --badge-offline-text: #71717a;

    --backup-gradient-start: #fed7aa;
    --backup-gradient-end: #fef3c7;
    --backup-border: #f59e0b;
    --backup-title: #92400e;
    --backup-sub: #b45309;

    --banner-bg: #fef3c7;
    --banner-text: #92400e;
    --banner-link: #b45309;

    --checkbox-border: #94a3b8;
    --checkbox-check-text: #ffffff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg-base);
    color: var(--text-primary);
    min-height: 100vh;
    min-height: 100dvh;
    overflow-x: hidden;
  }

  #app {
    max-width: 480px;
    margin: 0 auto;
    padding: 16px 16px 100px;
  }

  /* ===== HEADER ===== */
  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; padding-top: 12px; }
  .header h1 { font-size: 28px; font-weight: 800; letter-spacing: 6px; color: var(--text-heading); }
  .header .sub { font-size: 11px; color: var(--text-dim); margin-top: 4px; letter-spacing: 1px; text-transform: uppercase; }
  .week-badge { display: flex; flex-direction: column; align-items: center; background: var(--bg-surface); padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border-default); }
  .week-badge .num { font-size: 24px; font-weight: 700; color: var(--accent); }
  .week-badge .label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }

  /* ===== TODAY CARD ===== */
  .today-card { background: linear-gradient(135deg, var(--bg-surface) 0%, var(--accent-bg-dark) 100%); border: 1px solid var(--accent-border); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
  .today-card .label { font-size: 11px; color: var(--accent); letter-spacing: 2px; font-weight: 600; margin-bottom: 8px; }
  .today-card h2 { font-size: 22px; font-weight: 700; color: var(--text-heading); margin-bottom: 4px; }
  .today-card .sub { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; }

  .rest-day-card { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: 12px; padding: 24px; margin-bottom: 24px; text-align: center; }
  .rest-day-card h2 { font-size: 18px; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; }
  .rest-day-card p { font-size: 13px; color: var(--text-dim); }

  /* ===== BUTTONS ===== */
  .btn-primary { background: var(--accent); color: var(--on-accent); border: none; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 700; font-family: inherit; cursor: pointer; width: 100%; letter-spacing: 1px; }
  .btn-primary:active { background: var(--accent-pressed); }
  .btn-outline { background: none; border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-muted); padding: 6px 12px; font-size: 12px; font-family: inherit; cursor: pointer; }
  .btn-finish { background: var(--accent); color: var(--on-accent); border: none; border-radius: 6px; padding: 6px 14px; font-size: 12px; font-weight: 700; font-family: inherit; cursor: pointer; }
  .btn-finish-lg { background: var(--accent); color: var(--on-accent); border: none; border-radius: 10px; padding: 14px 24px; font-size: 15px; font-weight: 700; font-family: inherit; cursor: pointer; width: 100%; margin-top: 24px; letter-spacing: 1px; }
  .btn-done { background: var(--bg-elevated); border: none; border-radius: 4px; color: var(--accent); padding: 4px 12px; font-size: 12px; font-weight: 600; font-family: inherit; cursor: pointer; }
  .btn-done:active { background: var(--bg-pressed); }
  .btn-reset { background: none; border: 1px solid var(--danger-border); border-radius: 6px; color: var(--danger); padding: 8px 16px; font-size: 12px; font-family: inherit; cursor: pointer; margin-top: 32px; width: 100%; }
  .btn-skip { background: none; border: 1px solid var(--warning); border-radius: 4px; color: var(--warning); padding: 4px 10px; font-size: 11px; font-family: inherit; cursor: pointer; }

  /* ===== SECTIONS ===== */
  .section { margin-bottom: 28px; }
  .section-title { font-size: 12px; font-weight: 600; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; }

  /* ===== DAY GRID ===== */
  .day-grid { display: flex; flex-direction: column; gap: 8px; }
  .day-card { display: flex; align-items: center; gap: 12px; background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: 8px; padding: 12px 16px; cursor: pointer; font-family: inherit; color: var(--text-primary); text-align: left; width: 100%; }
  .day-card:active { background: var(--bg-elevated); }
  .day-card.done { border-color: var(--accent); }
  .day-card .name { font-size: 14px; font-weight: 600; min-width: 70px; }
  .day-card .sub { font-size: 12px; color: var(--text-muted); flex: 1; }
  .day-card .done-label { font-size: 11px; color: var(--accent); font-weight: 600; }

  /* ===== CHECKLIST ===== */
  .checklist-row { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; background: none; border: none; cursor: pointer; font-family: inherit; text-align: left; width: 100%; color: var(--text-primary); border-bottom: 1px solid var(--border-subtle); }
  .checkbox { width: 20px; height: 20px; min-width: 20px; border-radius: 4px; border: 2px solid var(--checkbox-border); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--checkbox-check-text); margin-top: 1px; transition: all 0.15s; }
  .checkbox.checked { background: var(--accent); border-color: var(--accent); }
  .checklist-text { font-size: 13px; line-height: 1.4; color: var(--text-secondary); }
  .checklist-text.checked { text-decoration: line-through; opacity: 0.6; }
  .checklist-score { text-align: right; font-size: 13px; color: var(--accent); font-weight: 600; margin-top: 8px; }

  /* ===== NAV BAR ===== */
  .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-surface); border-top: 1px solid var(--border-default); display: flex; justify-content: center; gap: 48px; padding: 12px 0; z-index: 100; }
  .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; cursor: pointer; font-family: inherit; color: var(--text-muted); }
  .nav-btn .icon { font-size: 20px; }
  .nav-btn .label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

  /* ===== WORKOUT VIEW ===== */
  .workout-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-top: 8px; }
  .workout-header .center h1 { font-size: 20px; font-weight: 700; color: var(--text-heading); text-align: center; }
  .workout-header .center p { font-size: 12px; color: var(--text-dim); text-align: center; margin-top: 2px; }

  #rest-timer { position: fixed; top: 0; left: 0; right: 0; z-index: 150; }
  #rest-timer:empty { display: none; }
  .rest-pill { background: var(--timer-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding: 10px 20px; display: flex; align-items: center; justify-content: center; gap: 16px; }
  .rest-pill .rest-label { font-size: 12px; font-weight: 700; color: var(--timer-label); letter-spacing: 2px; }
  .rest-pill .rest-time { font-size: 28px; font-weight: 800; color: var(--timer-time); font-variant-numeric: tabular-nums; }
  .timer-active { padding-top: 56px; }

  .exercise-list { display: flex; flex-direction: column; gap: 16px; }
  .exercise-card { background: var(--bg-surface); border-radius: 10px; padding: 16px; border: 1px solid var(--border-default); border-left: 4px solid var(--border-default); }
  .exercise-card.completed { border-left-color: var(--accent); }
  .ex-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .ex-name { font-size: 15px; font-weight: 700; color: var(--text-title); margin-bottom: 4px; }
  .ex-meta { font-size: 11px; color: var(--text-dim); }
  .ex-note { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-style: italic; }
  .ex-check { font-size: 20px; color: var(--accent); font-weight: 700; }

  .controls-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
  .control-group { flex: 1; min-width: 120px; }
  .control-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 6px; }
  .number-input { display: flex; align-items: center; background: var(--bg-base); border-radius: 6px; border: 1px solid var(--border-default); overflow: hidden; }
  .num-btn { background: var(--bg-elevated); border: none; color: var(--text-primary); padding: 8px 14px; font-size: 16px; font-family: inherit; cursor: pointer; font-weight: 700; }
  .num-btn:active { background: var(--bg-pressed); }
  .num-btn-sm { background: var(--bg-elevated); border: none; color: var(--text-primary); padding: 4px 10px; font-size: 14px; font-family: inherit; cursor: pointer; font-weight: 700; }
  .num-btn-sm:active { background: var(--bg-pressed); }
  .num-value { flex: 1; text-align: center; font-size: 16px; font-weight: 700; color: var(--text-heading); }
  .num-value-sm { width: 32px; text-align: center; font-size: 14px; font-weight: 700; color: var(--text-heading); }

  .technique-select { background: var(--bg-base); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); padding: 8px 10px; font-size: 12px; font-family: inherit; width: 100%; appearance: none; -webkit-appearance: none; }

  .sets-container { display: flex; flex-direction: column; gap: 6px; }
  .set-row { display: flex; align-items: center; gap: 10px; padding: 6px 8px; background: var(--bg-base); border-radius: 6px; }
  .set-row.done { opacity: 0.6; }
  .set-label { font-size: 12px; color: var(--text-dim); font-weight: 600; min-width: 40px; }
  .reps-label { font-size: 11px; color: var(--text-dim); flex: 1; }
  .done-check { color: var(--accent); font-weight: 700; font-size: 16px; width: 40px; text-align: center; }

  .notes-input { width: 100%; background: var(--bg-base); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-muted); padding: 8px 10px; font-size: 12px; font-family: inherit; margin-top: 10px; }

  /* ===== HISTORY ===== */
  .history-date { font-size: 13px; color: var(--accent); font-weight: 600; margin-bottom: 8px; letter-spacing: 1px; }
  .history-card { background: var(--bg-surface); border-radius: 8px; padding: 14px; margin-bottom: 8px; border: 1px solid var(--border-default); }
  .history-day-name { font-size: 14px; font-weight: 700; color: var(--text-title); margin-bottom: 10px; }
  .history-ex-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid var(--bg-base); }
  .history-ex-name { font-size: 12px; color: var(--text-secondary); }
  .history-ex-detail { font-size: 11px; color: var(--text-dim); text-align: right; }

  /* ===== PROGRESS ===== */
  .progress-day-title { font-size: 14px; font-weight: 700; color: var(--accent); margin-bottom: 10px; letter-spacing: 1px; }
  .progress-ex-row { background: var(--bg-surface); border-radius: 8px; padding: 10px 14px; margin-bottom: 6px; border: 1px solid var(--border-default); }
  .progress-ex-name { font-size: 13px; font-weight: 600; color: var(--text-title); margin-bottom: 4px; }
  .progress-stats { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .progress-stat { font-size: 12px; color: var(--text-muted); }
  .progress-diff { font-size: 12px; font-weight: 700; }
  .progress-diff.up { color: var(--accent); }
  .progress-diff.down { color: var(--danger); }
  .progress-sep { font-size: 12px; color: var(--border-default); }
  .progress-sessions { font-size: 10px; color: var(--text-dim); margin-top: 4px; }

  .empty-text { color: var(--text-dim); font-size: 14px; text-align: center; padding: 40px 0; }
  .nav-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 8px; }
  .page-title { font-size: 20px; font-weight: 700; color: var(--text-heading); }
  .saving { position: fixed; bottom: 60px; right: 16px; background: var(--bg-elevated); color: var(--text-muted); padding: 6px 12px; border-radius: 6px; font-size: 11px; z-index: 200; }

  .history-block { margin-bottom: 20px; }
  .progress-block { margin-bottom: 24px; }

  /* ===== SETTINGS ===== */
  .gear-btn { background: none; border: 1px solid var(--border-default); border-radius: 8px; padding: 8px 10px; cursor: pointer; font-size: 18px; line-height: 1; }
  .settings-section { margin-bottom: 28px; }
  .settings-section-title { font-size: 12px; font-weight: 600; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; }
  .settings-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border-subtle); }
  .settings-row .info { flex: 1; }
  .settings-row .info .title { font-size: 14px; color: var(--text-primary); font-weight: 600; }
  .settings-row .info .sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .settings-btn { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); padding: 8px 16px; font-size: 12px; font-family: inherit; cursor: pointer; font-weight: 600; white-space: nowrap; }
  .settings-btn:active { background: var(--bg-elevated); }
  .settings-btn.primary { background: var(--accent); color: var(--on-accent); border-color: var(--accent); }
  .settings-btn.primary:active { background: var(--accent-pressed); }
  .settings-btn.danger { background: none; border-color: var(--danger-border); color: var(--danger); }
  .settings-btn.danger:active { background: var(--danger-border); }
  .settings-stat { text-align: center; flex: 1; }
  .settings-stat .num { font-size: 24px; font-weight: 700; color: var(--accent); }
  .settings-stat .label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
  .settings-stats { display: flex; gap: 12px; padding: 16px; background: var(--bg-surface); border-radius: 10px; border: 1px solid var(--border-default); margin-bottom: 8px; }
  .backup-reminder { background: linear-gradient(135deg, var(--backup-gradient-start) 0%, var(--backup-gradient-end) 100%); border: 1px solid var(--backup-border); border-radius: 10px; padding: 14px 16px; margin-bottom: 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
  .backup-reminder .msg { flex: 1; }
  .backup-reminder .msg .title { font-size: 13px; font-weight: 700; color: var(--backup-title); }
  .backup-reminder .msg .sub { font-size: 11px; color: var(--backup-sub); margin-top: 2px; }
  .backup-dismiss { background: none; border: none; color: var(--backup-title); font-size: 18px; cursor: pointer; padding: 4px 8px; font-family: inherit; }

  /* ===== FILE PROTOCOL BANNER ===== */
  .file-banner { background: var(--banner-bg); color: var(--banner-text); padding: 10px 16px; font-size: 12px; text-align: center; line-height: 1.4; }
  .file-banner a { color: var(--banner-link); font-weight: 700; }

  /* ===== TOAST ===== */
  #toast { position: fixed; top: -60px; left: 50%; transform: translateX(-50%); z-index: 200; transition: top 0.3s ease; pointer-events: none; }
  #toast.show { top: 12px; }
  .toast-pill { background: var(--toast-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid var(--border-default); border-radius: 8px; padding: 10px 20px; font-size: 12px; font-weight: 600; color: var(--text-primary); white-space: nowrap; }
  .toast-pill.success { border-color: var(--accent-border); color: var(--accent); }
  .toast-pill.error { border-color: var(--danger-border); color: var(--danger); }

  /* ===== SYNC STATUS ===== */
  .sync-key-input { width: 100%; background: var(--bg-base); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); padding: 10px 12px; font-size: 13px; font-family: inherit; }
  .sync-key-input::placeholder { color: var(--bg-pressed); }
  .sync-key-row { display: flex; gap: 8px; margin-bottom: 8px; }
  .sync-key-row input { flex: 1; }
  .sync-status-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; }
  .sync-status-badge.synced { background: var(--accent-bg); color: var(--accent); }
  .sync-status-badge.syncing { background: var(--badge-syncing-bg); color: var(--badge-syncing-text); }
  .sync-status-badge.offline { background: var(--badge-offline-bg); color: var(--badge-offline-text); }
  .sync-status-badge.error { background: var(--danger-bg); color: var(--danger); }
  .sync-status-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
  .sync-status-badge.syncing .dot { animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
  .sync-meta { font-size: 11px; color: var(--text-dim); margin-top: 6px; }
  .chart-container { margin: 8px 0; }

  /* ===== TABLET (768px+) ===== */
  @media (min-width: 768px) {
    #app { max-width: 720px; padding: 24px 32px 100px; }
    .header h1 { font-size: 32px; }
    .header .sub { font-size: 12px; }
    .today-card h2 { font-size: 24px; }
    .today-card .sub { font-size: 14px; }
    .btn-primary { font-size: 15px; padding: 14px 24px; }
    .day-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .day-card .name { font-size: 15px; }
    .day-card .sub { font-size: 13px; }
    .exercise-card { padding: 20px; }
    .ex-name { font-size: 16px; }
    .section-title { font-size: 13px; }
    .nav-bar { gap: 80px; }
    .rest-pill { max-width: 720px; margin: 0 auto; }
    .timer-active { padding-top: 56px; }
    .page-title { font-size: 22px; }
    .checklist-text { font-size: 14px; }
  }

  /* ===== DESKTOP (1200px+) ===== */
  @media (min-width: 1200px) {
    #app { max-width: 1000px; padding: 32px 40px 100px; }
    .header h1 { font-size: 36px; }
    .header .sub { font-size: 13px; }
    .today-card { padding: 24px; }
    .today-card h2 { font-size: 26px; }
    .btn-primary { font-size: 16px; }
    .day-grid { grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .day-card .name { font-size: 15px; min-width: 80px; }
    .exercise-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; align-items: start; }
    .exercise-card { padding: 20px; }
    .ex-name { font-size: 17px; }
    .section-title { font-size: 13px; }
    .nav-bar { gap: 120px; }
    .rest-pill { max-width: 1000px; }
    .timer-active { padding-top: 60px; }
    .page-title { font-size: 24px; }
    .history-block .history-card { display: inline-block; width: calc(50% - 4px); vertical-align: top; }
    .history-block .history-card:nth-child(odd) { margin-right: 4px; }
    .progress-ex-row { display: inline-block; width: calc(50% - 4px); vertical-align: top; }
    .progress-ex-row:nth-child(odd) { margin-right: 4px; }
  }
</style>
</head>
<body>
<div id="file-banner"></div>
<div id="app"></div>
<div id="rest-timer"></div>
<div id="toast"></div>

<script>
// ===== SYNC CONFIG =====
const SYNC_WORKER_URL = 'https://ironlog-sync.lds3.workers.dev';
const SYNC_DEBOUNCE_MS = 5000;

// ===== THEME =====
function getThemePreference() {
  return localStorage.getItem('ironlog-theme') || 'system';
}

function getEffectiveTheme(pref) {
  if (pref === 'dark' || pref === 'light') return pref;
  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  document.documentElement.style.colorScheme = theme;
  const metaTheme = document.querySelector('meta[name="theme-color"]');
  if (metaTheme) {
    metaTheme.setAttribute('content', theme === 'dark' ? '#0f172a' : '#f1f5f9');
  }
}

function setThemePreference(pref) {
  localStorage.setItem('ironlog-theme', pref);
  applyTheme(getEffectiveTheme(pref));
}

// Apply theme (reinforces head script, also handles dynamic changes)
applyTheme(getEffectiveTheme(getThemePreference()));

// Listen for OS theme changes when in "system" mode
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
  if (getThemePreference() === 'system') {
    applyTheme(getEffectiveTheme('system'));
  }
});

// Sync theme across tabs
window.addEventListener('storage', (e) => {
  if (e.key === 'ironlog-theme') {
    applyTheme(getEffectiveTheme(e.newValue || 'system'));
  }
});

const PROGRAM = {
  "Lower A": {
    subtitle: "Quad Focus",
    exercises: [
      { name: "Bulgarian Split Squat", sets: 4, repsLow: 8, repsHigh: 10, tempo: "3-1-1-0", defaultWeight: 45, note: "Each leg. Front foot elevated if possible.", rest: 90 },
      { name: "Goblet Squat (1.5 rep)", sets: 3, repsLow: 8, repsHigh: 10, tempo: "Controlled", defaultWeight: 50, note: "Down, halfway up, back down, all the way up = 1 rep.", rest: 90 },
      { name: "DB Walking Lunge", sets: 3, repsLow: 12, repsHigh: 12, tempo: "Controlled", defaultWeight: 40, note: "Each leg. Long stride, upright torso.", rest: 60 },
      { name: "Single Leg DB RDL", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-0-1-1", defaultWeight: 40, note: "Each leg. Squeeze glute at top.", rest: 60 },
      { name: "Single Leg Calf Raise", sets: 3, repsLow: 15, repsHigh: 20, tempo: "2-1-1-1", defaultWeight: 45, note: "Each leg. Stand on step edge.", rest: 60 },
    ],
  },
  "Upper A": {
    subtitle: "Push Focus",
    exercises: [
      { name: "DB Floor Press", sets: 4, repsLow: 8, repsHigh: 10, tempo: "3-2-1-0", defaultWeight: 50, note: "2-sec pause at bottom eliminates stretch reflex.", rest: 90 },
      { name: "Incline DB Press", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-1-1-0", defaultWeight: 40, note: "Use angled surface or propped pillows.", rest: 90 },
      { name: "Seated OH Press (wall)", sets: 3, repsLow: 8, repsHigh: 10, tempo: "3-1-1-0", defaultWeight: 40, note: "Back against wall. No leaning.", rest: 90 },
      { name: "Lateral Raise", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-1-2-0", defaultWeight: 15, note: "Slow up AND down. No swinging.", rest: 60 },
      { name: "OH Tricep Extension", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-1-1-0", defaultWeight: 45, note: "Both arms, single DB.", rest: 60 },
    ],
  },
  "Lower B": {
    subtitle: "Hinge Focus",
    exercises: [
      { name: "DB Romanian Deadlift", sets: 4, repsLow: 8, repsHigh: 10, tempo: "4-1-1-1", defaultWeight: 50, note: "4-sec lowering. Feel hamstring stretch.", rest: 90 },
      { name: "DB Sumo Squat", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-2-1-0", defaultWeight: 50, note: "Single DB held at center. 2-sec pause.", rest: 90 },
      { name: "Single Leg Hip Thrust", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-2-1-0", defaultWeight: 35, note: "Each leg. Back on couch. Squeeze at top.", rest: 60 },
      { name: "Deficit Reverse Lunge", sets: 3, repsLow: 10, repsHigh: 10, tempo: "3-0-1-0", defaultWeight: 40, note: "Each leg. Stand on step for extra ROM.", rest: 60 },
      { name: "Calf Raise (both legs)", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-2-1-2", defaultWeight: 50, note: "Hold at top and bottom. Per hand.", rest: 60 },
    ],
  },
  "Upper B": {
    subtitle: "Pull Focus",
    exercises: [
      { name: "Single Arm DB Row", sets: 4, repsLow: 8, repsHigh: 10, tempo: "2-1-1-2", defaultWeight: 50, note: "Each arm. 2-sec squeeze at top.", rest: 90 },
      { name: "Chest-Supported Row", sets: 3, repsLow: 10, repsHigh: 12, tempo: "2-1-1-1", defaultWeight: 40, note: "Lie face down on angled surface. Per hand.", rest: 90 },
      { name: "DB Pullover", sets: 3, repsLow: 12, repsHigh: 15, tempo: "3-0-1-1", defaultWeight: 40, note: "Slight elbow bend. Deep stretch.", rest: 60 },
      { name: "Seated Alternating Curl", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-0-1-1", defaultWeight: 25, note: "Each arm. Seated removes momentum.", rest: 60 },
      { name: "Hammer Curl to Press", sets: 3, repsLow: 10, repsHigh: 10, tempo: "Controlled", defaultWeight: 25, note: "Curl up, press overhead, lower.", rest: 60 },
    ],
  },
  "Day 5": {
    subtitle: "Arms, Shoulders, Abs (Optional)",
    exercises: [
      { name: "Concentration Curl", sets: 3, repsLow: 10, repsHigh: 12, tempo: "3-0-1-1", defaultWeight: 25, note: "Each arm. Elbow braced on inner thigh.", rest: 60 },
      { name: "Tricep Kickback", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-1-1-0", defaultWeight: 20, note: "Each arm. Full extension, squeeze.", rest: 60 },
      { name: "Arnold Press", sets: 3, repsLow: 10, repsHigh: 12, tempo: "Controlled", defaultWeight: 30, note: "Rotation through the press.", rest: 60 },
      { name: "Reverse Fly", sets: 3, repsLow: 12, repsHigh: 15, tempo: "2-1-2-0", defaultWeight: 15, note: "Bent over. Rear delts.", rest: 60 },
      { name: "Lying Leg Raise", sets: 3, repsLow: 15, repsHigh: 20, tempo: "Controlled", defaultWeight: 0, note: "Slow and controlled.", rest: 45 },
    ],
  },
};

const DAYS_ORDER = ["Lower A", "Upper A", "Lower B", "Upper B", "Day 5"];
const WEEK_SCHEDULE = { Sat: "Lower A", Sun: "Upper A", Mon: null, Tue: "Lower B", Wed: null, Thu: "Upper B", Fri: "Day 5" };
const TECHNIQUES = ["Standard", "1.5 Reps", "Pause Reps", "Rest-Pause", "Mech. Drop Set", "Slow Tempo (+1s)"];
const CHECKLIST_ITEMS = [
  "Hit all 4 scheduled sessions (5 if including optional day)",
  "Improved at least 2 exercises (more reps, sets, tempo, or technique)",
  "Hit 150g+ protein on at least 5 of 7 days",
  "No exercises felt 'easy' by the final set",
  "Logged every session with weight, reps, sets, and tempo",
];

let state = { view: "home", activeDay: null, workoutData: {}, history: {}, checklist: {}, restTimer: null, restTimeLeft: 0, restInterval: null, restDuration: 0, lastExportDate: null, backupDismissDate: null, syncKey: null, syncEnabled: true, lastSyncedAt: null, syncStatus: 'idle', needsSync: false };
let syncDebounceTimer = null;

function getToday() { return new Date().toISOString().split("T")[0]; }
function getDayName() { return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date().getDay()]; }
function getWeekId(d) {
  const date = new Date(d); date.setHours(0,0,0,0);
  const dayNum = date.getDay() || 7;
  date.setDate(date.getDate() + 4 - dayNum);
  const yearStart = new Date(date.getFullYear(), 0, 1);
  const weekNo = Math.ceil(((date - yearStart) / 86400000 + 1) / 7);
  return `${date.getFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

function snapWeight(w) { return Math.round(w / 5) * 5; }

function hasCompletedSets(dayData) {
  return Object.values(dayData).some(ex => ex.sets?.some(s => s.completed));
}

function loadData() {
  try {
    const raw = localStorage.getItem("ironlog-data");
    if (!raw) {
      // Try IndexedDB fallback
      loadFromIDB().then(idbData => {
        if (idbData) {
          state.history = idbData.history || {};
          state.checklist = idbData.checklist || {};
          state.lastExportDate = idbData.lastExportDate || null;
          state.backupDismissDate = idbData.backupDismissDate || null;
          saveData(); render();
          showToast('Recovered data from backup', 'success');
        }
      });
      return;
    }
    const p = JSON.parse(raw);
    if (!p.version) {
      localStorage.setItem("ironlog-data-v1-backup", raw);
      state.history = p.history || {};
      state.checklist = p.checklist || {};
      state.lastExportDate = null;
      state.backupDismissDate = null;
      saveData();
    } else if (p.version === 2) {
      state.history = p.history || {};
      state.checklist = p.checklist || {};
      state.lastExportDate = p.lastExportDate || null;
      state.backupDismissDate = p.backupDismissDate || null;
    } else {
      console.warn("Unknown data version:", p.version);
    }
  } catch(e) { console.log("No data yet"); }
  // Snap stored weights to 5 lb increments
  let weightFixed = false;
  for (const date in state.history) {
    for (const day in state.history[date]) {
      state.history[date][day].forEach(ex => {
        if (typeof ex.weight === 'number' && ex.weight % 5 !== 0) {
          const old = ex.weight;
          ex.weight = snapWeight(ex.weight);
          console.log(`[Iron Log] Migrated weight: ${day} ${date}, ${old} → ${ex.weight}`);
          weightFixed = true;
        }
      });
    }
  }
  if (weightFixed) saveData();
  // Load sync settings
  try {
    const sync = localStorage.getItem("ironlog-sync");
    if (sync) {
      const s = JSON.parse(sync);
      state.syncKey = s.syncKey || null;
      state.syncEnabled = s.syncEnabled !== false;
      state.lastSyncedAt = s.lastSyncedAt || null;
    }
  } catch(e) { /* no sync config */ }
}

function saveData() {
  const payload = { version: 2, history: state.history, checklist: state.checklist, lastExportDate: state.lastExportDate, backupDismissDate: state.backupDismissDate };
  try { localStorage.setItem("ironlog-data", JSON.stringify(payload)); } catch(e) { console.error(e); showToast('Storage full — backup only', 'error'); }
  saveToIDB(payload);
  debouncedSync();
}

function saveSyncSettings() {
  try { localStorage.setItem("ironlog-sync", JSON.stringify({ syncKey: state.syncKey, syncEnabled: state.syncEnabled, lastSyncedAt: state.lastSyncedAt })); } catch(e) { /* */ }
}

function getLastVal(dayName, exIndex, field) {
  const dates = Object.keys(state.history).sort().reverse();
  for (const d of dates) { if (state.history[d]?.[dayName]?.[exIndex]) return state.history[d][dayName][exIndex][field]; }
  return null;
}

function getLastReps(dayName, exIndex, setIndex) {
  const dates = Object.keys(state.history).sort().reverse();
  for (const d of dates) { const s = state.history[d]?.[dayName]?.[exIndex]?.sets?.[setIndex]; if (s) return s.reps; }
  return null;
}

function getWeekSessions() {
  const wid = getWeekId(new Date()); let c = 0;
  Object.keys(state.history).forEach(d => {
    if (getWeekId(d) === wid) {
      Object.values(state.history[d]).forEach(dayData => { if (hasCompletedSets(dayData)) c++; });
    }
  });
  return c;
}

function startWorkout(dayName) {
  const prog = PROGRAM[dayName]; const today = getToday();
  if (state.history[today]?.[dayName]) { state.workoutData = JSON.parse(JSON.stringify(state.history[today][dayName])); }
  else {
    const data = {};
    prog.exercises.forEach((ex, i) => {
      data[i] = { weight: getLastVal(dayName, i, "weight") || ex.defaultWeight, technique: getLastVal(dayName, i, "technique") || "Standard",
        sets: Array.from({length: ex.sets}, (_, si) => ({ reps: getLastReps(dayName, i, si) || ex.repsLow, completed: false })), notes: "" };
    });
    state.workoutData = data;
  }
  state.activeDay = dayName; state.view = "workout"; render();
}

function finishWorkout() {
  const today = getToday();
  if (!state.history[today]) state.history[today] = {};
  state.history[today][state.activeDay] = JSON.parse(JSON.stringify(state.workoutData));
  saveData(); state.view = "home"; state.activeDay = null; state.workoutData = {}; stopRest(); render();
}

// Persist to history on each set completion for crash resilience
function completeSet(exIndex, setIndex, restTime) {
  state.workoutData[exIndex].sets[setIndex].completed = true;
  const today = getToday();
  if (!state.history[today]) state.history[today] = {};
  state.history[today][state.activeDay] = JSON.parse(JSON.stringify(state.workoutData));
  saveData();
  startRest(restTime);
  render();
}

function goBack() {
  const today = getToday();
  const anyCompleted = hasCompletedSets(state.workoutData);
  if (!anyCompleted && state.history[today]?.[state.activeDay]) {
    delete state.history[today][state.activeDay];
    if (Object.keys(state.history[today]).length === 0) delete state.history[today];
    saveData();
  }
  state.view = "home"; state.activeDay = null; state.workoutData = {}; stopRest(); render();
}

function renderTimer() {
  const el = document.getElementById("rest-timer");
  if (state.restTimeLeft > 0) {
    el.innerHTML = `<div class="rest-pill"><span class="rest-label">REST</span><span class="rest-time">${state.restTimeLeft}s</span><button class="btn-skip" onclick="stopRest()">Skip</button></div>`;
  } else {
    el.innerHTML = "";
  }
  document.getElementById("app").classList.toggle("timer-active", state.restTimeLeft > 0);
}

function startRest(seconds) {
  stopRest(); state.restTimeLeft = seconds; state.restDuration = seconds;
  state.restInterval = setInterval(() => {
    state.restTimeLeft--;
    if (state.restTimeLeft <= 0) { stopRest(); return; }
    renderTimer();
  }, 1000);
  renderTimer();
}

function stopRest() { if (state.restInterval) clearInterval(state.restInterval); state.restInterval = null; state.restTimeLeft = 0; state.restDuration = 0; renderTimer(); }

function toggleChecklist(i) {
  const wid = getWeekId(new Date()); const cur = state.checklist[wid] || [];
  state.checklist[wid] = cur.includes(i) ? cur.filter(x => x !== i) : [...cur, i];
  saveData(); render();
}


function getDataStats() {
  const dates = Object.keys(state.history);
  let exerciseEntries = 0;
  dates.forEach(d => Object.values(state.history[d]).forEach(day => { exerciseEntries += Object.keys(day).length; }));
  return { sessions: dates.length, exerciseEntries };
}

function buildExportPayload() {
  const dates = Object.keys(state.history).sort();
  return {
    version: 2,
    appVersion: "Iron Log v2",
    exportDate: new Date().toISOString(),
    totalSessions: dates.length,
    dateRange: dates.length > 0 ? { earliest: dates[0], latest: dates[dates.length - 1] } : null,
    history: state.history,
    checklist: state.checklist,
  };
}

function exportData() {
  const payload = buildExportPayload();
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ironlog-backup-" + getToday() + ".json";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  state.lastExportDate = new Date().toISOString();
  saveData(); render();
}

function copyDataToClipboard() {
  const payload = buildExportPayload();
  try {
    navigator.clipboard.writeText(JSON.stringify(payload, null, 2)).then(() => {
      alert("Data copied to clipboard!");
    }).catch(() => {
      alert("Clipboard not available. Use the download option instead.");
    });
  } catch(e) {
    alert("Clipboard not available. Use the download option instead.");
  }
}

function importData() {
  const input = document.createElement("input");
  input.type = "file"; input.accept = ".json";
  input.onchange = (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const imported = JSON.parse(ev.target.result);
        if (!imported.history || typeof imported.history !== "object") { alert("Invalid file: no history data found."); return; }
        if (imported.version && imported.version > 2) { alert("This backup was created by a newer version of Iron Log. Please update the app first."); return; }
        const importDates = Object.keys(imported.history);
        const existingDates = Object.keys(state.history);
        const overlap = importDates.filter(d => existingDates.includes(d));
        const newDates = importDates.filter(d => !existingDates.includes(d));
        const summary = `Import Summary:\n• ${importDates.length} total dates in file\n• ${newDates.length} new dates\n• ${overlap.length} overlapping dates\n\nProceed with import?`;
        if (!confirm(summary)) return;
        if (overlap.length > 0) {
          if (confirm("Overlapping dates found. OK = Merge (import overwrites conflicts), Cancel = Replace all data")) {
            overlap.forEach(d => { state.history[d] = { ...state.history[d], ...imported.history[d] }; });
            newDates.forEach(d => { state.history[d] = imported.history[d]; });
            if (imported.checklist) { Object.keys(imported.checklist).forEach(k => { state.checklist[k] = imported.checklist[k]; }); }
          } else {
            if (confirm("Replace ALL existing data with imported data? This cannot be undone.")) {
              state.history = imported.history;
              state.checklist = imported.checklist || {};
            } else { return; }
          }
        } else {
          newDates.forEach(d => { state.history[d] = imported.history[d]; });
          if (imported.checklist) { Object.keys(imported.checklist).forEach(k => { state.checklist[k] = imported.checklist[k]; }); }
        }
        saveData(); render();
        alert("Import complete!");
      } catch(err) { alert("Failed to parse file. Make sure it's a valid Iron Log backup."); }
    };
    reader.readAsText(file);
  };
  input.click();
}


function dismissBackupReminder() {
  state.backupDismissDate = new Date().toISOString();
  saveData(); render();
}

function getProgressData(dayName, exIndex) {
  const entries = [];
  Object.keys(state.history).sort().forEach(date => {
    const ex = state.history[date]?.[dayName]?.[exIndex];
    if (ex) { entries.push({ date, weight: ex.weight, totalReps: ex.sets.reduce((s,x) => s + (x.reps||0), 0), technique: ex.technique, numSets: ex.sets.length }); }
  });
  return entries;
}

// ===== INDEXEDDB BACKUP =====
function openIDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('ironlog-backup', 1);
    req.onupgradeneeded = () => req.result.createObjectStore('data');
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function saveToIDB(data) {
  openIDB().then(db => {
    const tx = db.transaction('data', 'readwrite');
    tx.objectStore('data').put(data, 'current');
  }).catch(() => { /* IDB unavailable — localStorage is primary */ });
}

function loadFromIDB() {
  return openIDB().then(db => {
    return new Promise((resolve) => {
      const tx = db.transaction('data', 'readonly');
      const req = tx.objectStore('data').get('current');
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => resolve(null);
    });
  }).catch(() => null);
}

// ===== TOAST =====
let toastTimer = null;
function showToast(message, type) {
  const el = document.getElementById('toast');
  if (!el) return;
  const pill = document.createElement('div');
  pill.className = 'toast-pill ' + (type || '');
  pill.textContent = message;
  el.replaceChildren(pill);
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.classList.remove('show'); }, 2500);
}

// ===== CLOUD SYNC =====
function canSync() {
  return SYNC_WORKER_URL && state.syncKey && state.syncKey.length >= 8 && state.syncEnabled;
}

function debouncedSync() {
  if (!canSync() || state.syncStatus === 'syncing') return;
  clearTimeout(syncDebounceTimer);
  syncDebounceTimer = setTimeout(() => syncToCloud(), SYNC_DEBOUNCE_MS);
}

async function syncToCloud() {
  if (!canSync() || !navigator.onLine) {
    state.needsSync = true;
    state.syncStatus = navigator.onLine ? 'idle' : 'offline';
    return;
  }
  state.syncStatus = 'syncing';
  if (state.view === 'settings') render();

  try {
    const payload = { version: 2, history: state.history, checklist: state.checklist, lastExportDate: state.lastExportDate, backupDismissDate: state.backupDismissDate };
    const resp = await fetch(SYNC_WORKER_URL + '/sync?key=' + encodeURIComponent(state.syncKey), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error || 'HTTP ' + resp.status);
    }

    const result = await resp.json();
    state.lastSyncedAt = result.serverUpdatedAt || new Date().toISOString();
    state.syncStatus = 'synced';
    state.needsSync = false;
    saveSyncSettings();
    showToast('Synced', 'success');
  } catch (e) {
    console.error('Sync push failed:', e);
    state.syncStatus = 'error';
    state.needsSync = true;
    showToast('Sync failed — will retry', 'error');
  }
  if (state.view === 'settings') render();
}

async function pullFromCloud() {
  if (!canSync() || !navigator.onLine) return;
  state.syncStatus = 'syncing';
  if (state.view === 'settings') render();

  try {
    const resp = await fetch(SYNC_WORKER_URL + '/sync?key=' + encodeURIComponent(state.syncKey));
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const result = await resp.json();

    if (!result.exists) {
      // No cloud data — push local to create it
      await syncToCloud();
      return;
    }

    const cloud = result.data;
    const localDates = Object.keys(state.history);
    const isLocalEmpty = localDates.length === 0;
    const isFirstSync = !state.lastSyncedAt;

    if (isFirstSync && !isLocalEmpty) {
      // Both have data on first sync — ask user
      const cloudDates = Object.keys(cloud.history || {});
      if (cloudDates.length > 0) {
        const choice = confirm('Found ' + cloudDates.length + ' session(s) in cloud and ' + localDates.length + ' locally.\n\nOK = Load cloud data\nCancel = Keep this device\'s data and push to cloud');
        if (choice) {
          applyCloudData(cloud);
        } else {
          await syncToCloud();
        }
        return;
      }
    }

    if (isLocalEmpty && result.exists) {
      // New device — pull cloud data
      applyCloudData(cloud);
      showToast('Loaded data from cloud', 'success');
      return;
    }

    // Normal sync — compare timestamps
    if (state.lastSyncedAt && result.serverUpdatedAt > state.lastSyncedAt) {
      applyCloudData(cloud);
    } else {
      // Local is same or newer — push
      await syncToCloud();
    }
  } catch (e) {
    console.error('Sync pull failed:', e);
    state.syncStatus = 'error';
    showToast('Sync failed', 'error');
  }
  if (state.view === 'settings') render();
}

function applyCloudData(cloud) {
  state.history = cloud.history || {};
  state.checklist = cloud.checklist || {};
  state.lastExportDate = cloud.lastExportDate || state.lastExportDate;
  state.backupDismissDate = cloud.backupDismissDate || state.backupDismissDate;
  state.lastSyncedAt = new Date().toISOString();
  state.syncStatus = 'synced';
  state.needsSync = false;
  saveData();
  saveSyncSettings();
  render();
}

function setSyncKey(key) {
  if (key && key.length < 8) {
    showToast('Key must be at least 8 characters', 'error');
    return;
  }
  if (state.syncKey && key !== state.syncKey) {
    if (!confirm('Changing your sync key will disconnect from your existing cloud data. Continue?')) return;
  }
  state.syncKey = key || null;
  state.lastSyncedAt = null;
  saveSyncSettings();
  if (key) pullFromCloud();
  render();
}

function toggleSync() {
  state.syncEnabled = !state.syncEnabled;
  saveSyncSettings();
  if (state.syncEnabled && canSync()) pullFromCloud();
  render();
}

function formatTimeAgo(isoStr) {
  if (!isoStr) return 'Never';
  const diff = Date.now() - new Date(isoStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hours = Math.floor(mins / 60);
  if (hours < 24) return hours + 'h ago';
  const days = Math.floor(hours / 24);
  return days + 'd ago';
}

function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }

function renderLineChart(dataPoints, options = {}) {
  const {
    width = 300, height = 150, color = 'var(--accent)',
    yLabel = '', emptyMsg = 'No data yet.',
    xLabelFn = function(label) {
      const d = new Date(label + 'T00:00:00');
      return isNaN(d) ? label : d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    },
    yFormat = function(v) { return String(Math.round(v)); },
    secondaryData = null, secondaryColor = 'var(--text-muted)'
  } = options;

  // Filter invalid entries
  const pts = dataPoints.filter(p => p && typeof p.value === 'number' && isFinite(p.value));
  if (pts.length === 0) return '<p class="empty-text">' + esc(emptyMsg) + '</p>';

  // LTTB downsampling
  function lttb(data, threshold) {
    if (data.length <= threshold || threshold < 3) return data;
    const out = [data[0]];
    const every = (data.length - 2) / (threshold - 2);
    let a = 0;
    for (let i = 0; i < threshold - 2; i++) {
      let avgX = 0, avgY = 0, rangeStart = Math.floor((i + 1) * every) + 1;
      let rangeEnd = Math.min(Math.floor((i + 2) * every) + 1, data.length);
      let rangeLen = rangeEnd - rangeStart;
      for (let j = rangeStart; j < rangeEnd; j++) { avgX += j; avgY += data[j].value; }
      avgX /= rangeLen; avgY /= rangeLen;
      let maxArea = -1, maxIdx = rangeStart;
      const pointAX = a, pointAY = data[a].value;
      let s = Math.floor(i * every) + 1;
      let e = Math.min(Math.floor((i + 1) * every) + 1, data.length);
      for (let j = s; j < e; j++) {
        const area = Math.abs((pointAX - avgX) * (data[j].value - pointAY) - (pointAX - j) * (avgY - pointAY));
        if (area > maxArea) { maxArea = area; maxIdx = j; }
      }
      out.push(data[maxIdx]);
      a = maxIdx;
    }
    out.push(data[data.length - 1]);
    return out;
  }

  const sampled = pts.length > 50 ? lttb(pts, 50) : pts;
  const secSampled = secondaryData
    ? (function() {
        const sf = secondaryData.filter(p => p && typeof p.value === 'number' && isFinite(p.value));
        return sf.length > 50 ? lttb(sf, 50) : sf;
      })()
    : null;

  // Y-axis range from all data
  let allVals = sampled.map(p => p.value);
  if (secSampled && secSampled.length > 0) allVals = allVals.concat(secSampled.map(p => p.value));
  let yMin = Math.min.apply(null, allVals), yMax = Math.max.apply(null, allVals);
  if (yMin === yMax) {
    const pad = yMin === 0 ? 1 : Math.abs(yMin) * 0.1;
    yMin -= pad; yMax += pad;
  } else {
    const range = yMax - yMin;
    yMin -= range * 0.1; yMax += range * 0.1;
  }
  if (allVals.every(v => v >= 0) && yMin < 0) yMin = 0;

  // Layout
  const padL = 40, padR = 10, padT = 10, padB = 24;
  const plotW = width - padL - padR, plotH = height - padT - padB;

  function xPos(i, total) { return padL + (total === 1 ? plotW / 2 : (i / (total - 1)) * plotW); }
  function yPos(v) { return padT + plotH - ((v - yMin) / (yMax - yMin)) * plotH; }

  // Build SVG parts
  let gridLines = '', yLabels = '';
  for (let i = 0; i < 4; i++) {
    const frac = i / 3, y = padT + plotH - frac * plotH, val = yMin + frac * (yMax - yMin);
    gridLines += '<line x1="' + padL + '" y1="' + y + '" x2="' + (width - padR) + '" y2="' + y +
      '" stroke="var(--border-subtle)" stroke-width="0.5"/>';
    const label = yFormat(val) + (yLabel ? ' ' + yLabel : '');
    yLabels += '<text x="' + (padL - 3) + '" y="' + (y + 3) +
      '" text-anchor="end" font-size="8" fill="var(--text-dim)">' + esc(label) + '</text>';
  }

  // X labels: up to 5 evenly spaced
  let xLabelsHTML = '';
  const src = sampled;
  if (src.length === 1) {
    xLabelsHTML = '<text x="' + xPos(0, 1) + '" y="' + (height - 4) +
      '" text-anchor="middle" font-size="7" fill="var(--text-dim)">' + esc(xLabelFn(src[0].label)) + '</text>';
  } else if (src.length > 1) {
    const indices = [0];
    const count = Math.min(5, src.length);
    for (let i = 1; i < count - 1; i++) {
      const idx = Math.round((i / (count - 1)) * (src.length - 1));
      if (idx !== 0 && idx !== src.length - 1 && indices.indexOf(idx) === -1) indices.push(idx);
    }
    indices.push(src.length - 1);
    for (let k = 0; k < indices.length; k++) {
      const idx = indices[k];
      xLabelsHTML += '<text x="' + xPos(idx, src.length) + '" y="' + (height - 4) +
        '" text-anchor="middle" font-size="7" fill="var(--text-dim)">' + esc(xLabelFn(src[idx].label)) + '</text>';
    }
  }

  // Secondary line
  let secLine = '';
  if (secSampled && secSampled.length > 1) {
    let secPoints = '';
    for (let i = 0; i < secSampled.length; i++) {
      secPoints += xPos(i, secSampled.length) + ',' + yPos(secSampled[i].value) + (i < secSampled.length - 1 ? ' ' : '');
    }
    secLine = '<polyline points="' + secPoints + '" fill="none" stroke="' + secondaryColor +
      '" stroke-width="2" opacity="0.6" stroke-linecap="round" stroke-linejoin="round"/>';
  }

  // Primary line + circles
  let primaryLine = '', circles = '';
  if (sampled.length > 1) {
    let linePoints = '';
    for (let i = 0; i < sampled.length; i++) {
      linePoints += xPos(i, sampled.length) + ',' + yPos(sampled[i].value) + (i < sampled.length - 1 ? ' ' : '');
    }
    primaryLine = '<polyline points="' + linePoints + '" fill="none" stroke="' + color +
      '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>';
  }
  for (let i = 0; i < sampled.length; i++) {
    const cx = xPos(i, sampled.length), cy = yPos(sampled[i].value);
    const tip = xLabelFn(sampled[i].label) + ': ' + yFormat(sampled[i].value) + (yLabel ? ' ' + yLabel : '');
    circles += '<circle cx="' + cx + '" cy="' + cy + '" r="2.5" fill="' + color +
      '" stroke="var(--bg-surface)" stroke-width="1"><title>' + esc(tip) + '</title></circle>';
  }

  return '<div class="chart-container"><svg viewBox="0 0 ' + width + ' ' + height +
    '" role="img" aria-label="Line chart" style="width:100%;height:auto;display:block;font-family:\'JetBrains Mono\',monospace">' +
    gridLines + yLabels + xLabelsHTML + secLine + primaryLine + circles + '</svg></div>';
}

function renderHome() {
  const day = getDayName(); const suggested = WEEK_SCHEDULE[day]; const ws = getWeekSessions();
  const wid = getWeekId(new Date()); const checked = state.checklist[wid] || [];
  const today = getToday();

  let todayHTML = "";
  if (suggested) {
    const hasDone = state.history[today]?.[suggested] && hasCompletedSets(state.history[today][suggested]);
    todayHTML = `<div class="today-card">
      <div class="label">TODAY — ${day.toUpperCase()}</div>
      <h2>${suggested}</h2>
      <div class="sub">${PROGRAM[suggested].subtitle}</div>
      <button class="btn-primary" onclick="startWorkout('${suggested}')">${hasDone ? "Continue Workout →" : "Start Workout →"}</button>
    </div>`;
  } else {
    todayHTML = `<div class="rest-day-card"><h2>Rest Day</h2><p>Recover. Eat protein. Come back stronger.</p></div>`;
  }

  let dayCards = DAYS_ORDER.map(d => {
    const done = state.history[today]?.[d] && hasCompletedSets(state.history[today][d]);
    return `<button class="day-card${done ? ' done' : ''}" onclick="startWorkout('${d}')">
      <span class="name">${d}</span><span class="sub">${PROGRAM[d].subtitle}</span>${done ? '<span class="done-label">✓ Done</span>' : ''}
    </button>`;
  }).join("");

  let checklistHTML = CHECKLIST_ITEMS.map((item, i) => {
    const c = checked.includes(i);
    return `<button class="checklist-row" onclick="toggleChecklist(${i})">
      <span class="checkbox${c ? ' checked' : ''}">${c ? '✓' : ''}</span>
      <span class="checklist-text${c ? ' checked' : ''}">${esc(item)}</span>
    </button>`;
  }).join("");

  let backupHTML = "";
  if (needsBackupReminder()) {
    backupHTML = `<div class="backup-reminder" onclick="state.view='settings';render()">
      <div class="msg"><div class="title">Back up your data</div><div class="sub">Tap to export your workout history</div></div>
      <button class="backup-dismiss" onclick="event.stopPropagation();dismissBackupReminder()">×</button>
    </div>`;
  }

  return `
    <div class="header">
      <div><h1>IRON LOG</h1><div class="sub">Dumbbell Hypertrophy Program</div></div>
      <div style="display:flex;gap:10px;align-items:flex-start"><div class="week-badge"><span class="num">${ws}</span><span class="label">this week</span></div><button class="gear-btn" onclick="state.view='settings';render()">⚙</button></div>
    </div>
    ${todayHTML}
    ${backupHTML}
    <div class="section"><div class="section-title">All Workouts</div><div class="day-grid">${dayCards}</div></div>
    <div class="section"><div class="section-title">Weekly Checklist</div>${checklistHTML}<div class="checklist-score">${checked.length}/5 this week</div></div>
    <div class="nav-bar">
      <button class="nav-btn" onclick="state.view='history';render()"><span class="icon">📋</span><span class="label">History</span></button>
      <button class="nav-btn" onclick="state.view='progress';render()"><span class="icon">📈</span><span class="label">Progress</span></button>
    </div>`;
}

function renderWorkout() {
  const prog = PROGRAM[state.activeDay]; const data = state.workoutData;

  let exercises = prog.exercises.map((ex, i) => {
    const d = data[i]; if (!d) return "";
    const allDone = d.sets.every(s => s.completed);

    let setsHTML = d.sets.map((s, si) => {
      return `<div class="set-row${s.completed ? ' done' : ''}">
        <span class="set-label">Set ${si+1}</span>
        <div class="number-input">
          <button class="num-btn-sm" onclick="state.workoutData[${i}].sets[${si}].reps=Math.max(0,state.workoutData[${i}].sets[${si}].reps-1);render()">−</button>
          <span class="num-value-sm">${s.reps}</span>
          <button class="num-btn-sm" onclick="state.workoutData[${i}].sets[${si}].reps++;render()">+</button>
        </div>
        <span class="reps-label">reps</span>
        ${!s.completed ? `<button class="btn-done" onclick="completeSet(${i},${si},${ex.rest})">Done</button>` : '<span class="done-check">✓</span>'}
      </div>`;
    }).join("");

    let techOptions = TECHNIQUES.map(t => `<option value="${t}"${d.technique === t ? ' selected' : ''}>${t}</option>`).join("");

    return `<div class="exercise-card${allDone ? ' completed' : ''}">
      <div class="ex-header"><div>
        <div class="ex-name">${esc(ex.name)}</div>
        <div class="ex-meta">${ex.sets}×${ex.repsLow}${ex.repsLow !== ex.repsHigh ? '–'+ex.repsHigh : ''} · ${ex.tempo} · Rest ${ex.rest}s</div>
        <div class="ex-note">${esc(ex.note)}</div>
      </div>${allDone ? '<span class="ex-check">✓</span>' : ''}</div>
      <div class="controls-row">
        <div class="control-group"><label class="control-label">Weight (lbs)</label>
          <div class="number-input">
            <button class="num-btn" onclick="state.workoutData[${i}].weight=Math.max(0,snapWeight(state.workoutData[${i}].weight-5));render()">−</button>
            <span class="num-value">${d.weight}</span>
            <button class="num-btn" onclick="state.workoutData[${i}].weight=snapWeight(state.workoutData[${i}].weight+5);render()">+</button>
          </div>
        </div>
        <div class="control-group"><label class="control-label">Technique</label>
          <select class="technique-select" onchange="state.workoutData[${i}].technique=this.value;render()">${techOptions}</select>
        </div>
      </div>
      <div class="sets-container">${setsHTML}</div>
      <input class="notes-input" placeholder="Notes..." value="${esc(d.notes || '')}" oninput="state.workoutData[${i}].notes=this.value">
    </div>`;
  }).join("");

  return `
    <div class="workout-header">
      <button class="btn-outline" onclick="goBack()">← Back</button>
      <div class="center"><h1>${state.activeDay}</h1><p>${prog.subtitle}</p></div>
      <button class="btn-finish" onclick="finishWorkout()">Finish ✓</button>
    </div>
    <div class="exercise-list">${exercises}</div>
    <button class="btn-finish-lg" onclick="finishWorkout()">Complete Workout ✓</button>`;
}

function renderHistory() {
  const dates = Object.keys(state.history).sort().reverse();
  let content = "";
  if (dates.length === 0) { content = '<p class="empty-text">No workouts logged yet. Get after it.</p>'; }
  else {
    content = dates.map(date => {
      const dateStr = new Date(date + "T12:00:00").toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" });
      let cards = Object.entries(state.history[date]).map(([dayName, exercises]) => {
        let rows = PROGRAM[dayName]?.exercises.map((ex, i) => {
          const d = exercises[i]; if (!d) return "";
          const reps = d.sets.map(s => s.reps).join("/");
          const tech = d.technique !== "Standard" ? ` · ${d.technique}` : "";
          return `<div class="history-ex-row"><span class="history-ex-name">${esc(ex.name)}</span><span class="history-ex-detail">${d.weight}lbs · ${reps}${tech}</span></div>`;
        }).join("") || "";
        return `<div class="history-card"><div class="history-day-name">${dayName} — ${PROGRAM[dayName]?.subtitle || ''}</div>${rows}</div>`;
      }).join("");
      return `<div class="history-block"><div class="history-date">${dateStr}</div>${cards}</div>`;
    }).join("");
  }

  return `
    <div class="nav-row">
      <button class="btn-outline" onclick="state.view='home';render()">← Back</button>
      <span class="page-title">History</span><div style="width:60px"></div>
    </div>
    ${content}`;
}

function renderProgress() {
  let content = "";
  let hasAny = false;

  DAYS_ORDER.forEach(dayName => {
    const prog = PROGRAM[dayName];
    let rows = "";
    let dayHasData = false;

    prog.exercises.forEach((ex, i) => {
      const data = getProgressData(dayName, i);
      if (data.length === 0) return;
      dayHasData = true; hasAny = true;
      const latest = data[data.length - 1]; const first = data[0];
      const rd = latest.totalReps - first.totalReps; const wd = latest.weight - first.weight;
      let wdHTML = wd !== 0 ? `<span class="progress-diff ${wd > 0 ? 'up' : 'down'}">${wd > 0 ? '+' : ''}${wd}</span>` : '';
      let rdHTML = rd !== 0 ? `<span class="progress-diff ${rd > 0 ? 'up' : 'down'}">${rd > 0 ? '+' : ''}${rd}</span>` : '';

      rows += `<div class="progress-ex-row">
        <div class="progress-ex-name">${esc(ex.name)}</div>
        <div class="progress-stats"><span class="progress-stat">${latest.weight}lbs</span>${wdHTML}<span class="progress-sep">·</span><span class="progress-stat">${latest.totalReps} total reps</span>${rdHTML}</div>
        <div class="progress-sessions">${data.length} session${data.length > 1 ? 's' : ''}</div>
      </div>`;
    });

    if (dayHasData) { content += `<div class="progress-block"><div class="progress-day-title">${dayName} — ${prog.subtitle}</div>${rows}</div>`; }
  });

  if (!hasAny) content = '<p class="empty-text">Complete some workouts to see your progress.</p>';

  return `
    <div class="nav-row">
      <button class="btn-outline" onclick="state.view='home';render()">← Back</button>
      <span class="page-title">Progress</span><div style="width:60px"></div>
    </div>
    ${content}`;
}

function renderSettings() {
  const stats = getDataStats();
  const lastExport = state.lastExportDate ? new Date(state.lastExportDate).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }) : "Never";
  const themePref = getThemePreference();
  const effectiveTheme = getEffectiveTheme(themePref);

  // Sync section
  let syncHTML = '';
  if (!SYNC_WORKER_URL) {
    syncHTML = '<div class="settings-section"><div class="settings-section-title">Cloud Sync</div><div class="settings-row"><div class="info"><div class="title" style="color:var(--text-dim)">Not configured</div><div class="sub">Set SYNC_WORKER_URL to enable cloud sync</div></div></div></div>';
  } else if (!state.syncKey) {
    syncHTML = `<div class="settings-section">
      <div class="settings-section-title">Cloud Sync</div>
      <div style="background:var(--bg-surface);border:1px solid var(--border-default);border-radius:10px;padding:16px">
        <div style="font-size:13px;color:var(--text-primary);font-weight:600;margin-bottom:4px">Set up sync</div>
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:12px">Enter a passphrase to sync across devices. Use the same key on all devices.</div>
        <div class="sync-key-row">
          <input class="sync-key-input" id="sync-key-input" type="password" placeholder="Enter sync key (min 8 chars)" minlength="8">
          <button class="settings-btn primary" onclick="setSyncKey(document.getElementById('sync-key-input').value)">Save</button>
        </div>
      </div>
    </div>`;
  } else {
    const statusClass = state.syncStatus === 'synced' ? 'synced' : state.syncStatus === 'syncing' ? 'syncing' : state.syncStatus === 'error' ? 'error' : state.syncStatus === 'offline' ? 'offline' : 'synced';
    const statusLabel = state.syncStatus === 'synced' ? 'Synced' : state.syncStatus === 'syncing' ? 'Syncing...' : state.syncStatus === 'error' ? 'Error' : state.syncStatus === 'offline' ? 'Offline' : 'Ready';
    syncHTML = `<div class="settings-section">
      <div class="settings-section-title">Cloud Sync</div>
      <div class="settings-row">
        <div class="info">
          <div class="title">Status</div>
          <div style="margin-top:6px"><span class="sync-status-badge ${statusClass}"><span class="dot"></span>${esc(statusLabel)}</span></div>
          <div class="sync-meta">Last synced: ${esc(formatTimeAgo(state.lastSyncedAt))}</div>
        </div>
        <button class="settings-btn primary" onclick="pullFromCloud()">Sync Now</button>
      </div>
      <div class="settings-row">
        <div class="info"><div class="title">Sync Key</div><div class="sub" id="sync-key-display" style="font-family:monospace">${state.syncKey ? '••••••••' : 'Not set'}</div></div>
        <button class="settings-btn" onclick="const el=document.getElementById('sync-key-display');el.textContent=el.textContent==='••••••••'?state.syncKey:'••••••••'">Show</button>
      </div>
      <div class="settings-row">
        <div class="info"><div class="title">Change Sync Key</div><div class="sub">Disconnect and use a different key</div></div>
        <button class="settings-btn" onclick="setSyncKey(prompt('Enter new sync key (min 8 chars):'))">Change</button>
      </div>
      <div class="settings-row">
        <div class="info"><div class="title">${state.syncEnabled ? 'Sync Enabled' : 'Sync Disabled'}</div><div class="sub">Toggle automatic cloud sync</div></div>
        <button class="settings-btn${state.syncEnabled ? '' : ' primary'}" onclick="toggleSync()">${state.syncEnabled ? 'Disable' : 'Enable'}</button>
      </div>
    </div>`;
  }

  return `
    <div class="nav-row">
      <button class="btn-outline" onclick="state.view='home';render()">← Back</button>
      <span class="page-title">Settings</span><div style="width:60px"></div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Data Summary</div>
      <div class="settings-stats">
        <div class="settings-stat"><div class="num">${stats.sessions}</div><div class="label">Sessions</div></div>
        <div class="settings-stat"><div class="num">${stats.exerciseEntries}</div><div class="label">Exercises</div></div>
      </div>
    </div>
    ${syncHTML}
    <div class="settings-section">
      <div class="settings-section-title">Export</div>
      <div class="settings-row">
        <div class="info"><div class="title">Download Backup</div><div class="sub">Last export: ${esc(lastExport)}</div></div>
        <button class="settings-btn primary" onclick="exportData()">Download</button>
      </div>
      <div class="settings-row">
        <div class="info"><div class="title">Copy to Clipboard</div><div class="sub">Copy JSON data to clipboard</div></div>
        <button class="settings-btn" onclick="copyDataToClipboard()">Copy</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Import</div>
      <div class="settings-row">
        <div class="info"><div class="title">Import Backup</div><div class="sub">Load a previously exported JSON file</div></div>
        <button class="settings-btn" onclick="importData()">Import</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">App</div>
      <div class="settings-row">
        <div class="info"><div class="title">Check for Updates</div><div class="sub">Check if a new version is available</div></div>
        <button class="settings-btn" onclick="checkForUpdates()">Check</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Appearance</div>
      <div class="settings-row">
        <div class="info">
          <div class="title">Theme</div>
          <div class="sub">${effectiveTheme === 'dark' ? 'Dark' : 'Light'}${themePref === 'system' ? ' (System)' : ''}</div>
        </div>
        <div style="display:flex;gap:4px">
          <button class="settings-btn${themePref === 'system' ? ' primary' : ''}" onclick="setThemePreference('system');render()">Auto</button>
          <button class="settings-btn${themePref === 'dark' ? ' primary' : ''}" onclick="setThemePreference('dark');render()">Dark</button>
          <button class="settings-btn${themePref === 'light' ? ' primary' : ''}" onclick="setThemePreference('light');render()">Light</button>
        </div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Danger Zone</div>
      <div class="settings-row">
        <div class="info"><div class="title" style="color:var(--danger)">Reset All Data</div><div class="sub">Permanently delete all workout history</div></div>
        <button class="settings-btn danger" onclick="resetData()">Reset</button>
      </div>
    </div>`;
}

function render() {
  const app = document.getElementById("app");
  switch (state.view) {
    case "home": app.innerHTML = renderHome(); break;
    case "workout": app.innerHTML = renderWorkout(); break;
    case "history": app.innerHTML = renderHistory(); break;
    case "progress": app.innerHTML = renderProgress(); break;
    case "settings": app.innerHTML = renderSettings(); break;
  }
}

// ===== BACKUP REMINDER (cloud-aware) =====
function needsBackupReminder() {
  if (Object.keys(state.history).length === 0) return false;
  // If cloud sync active and recent, suppress reminder
  if (canSync() && state.lastSyncedAt) {
    const sinceLast = Date.now() - new Date(state.lastSyncedAt).getTime();
    if (sinceLast < 24 * 60 * 60 * 1000) return false;
    // Sync stalled — show different warning (handled in render)
  }
  if (state.backupDismissDate) {
    const dismissed = new Date(state.backupDismissDate);
    if ((new Date() - dismissed) < 7 * 24 * 60 * 60 * 1000) return false;
  }
  if (!state.lastExportDate) return true;
  return (new Date() - new Date(state.lastExportDate)) > 14 * 24 * 60 * 60 * 1000;
}

// ===== AUTO-EXPORT BEFORE RESET =====
function resetData() {
  if (confirm("This will permanently delete ALL workout history. Are you sure?")) {
    if (confirm("This CANNOT be undone. A backup will be downloaded first. Proceed?")) {
      exportData(); // Auto-download backup
      localStorage.removeItem("ironlog-data"); state.history = {}; state.checklist = {}; state.lastExportDate = null; state.backupDismissDate = null; render();
    }
  }
}

// ===== SERVICE WORKER UPDATE CHECK =====
function checkForUpdates() {
  if (!('serviceWorker' in navigator)) {
    showToast('Service worker not supported', 'error');
    return;
  }
  navigator.serviceWorker.getRegistration().then(reg => {
    if (!reg) { showToast('No service worker registered', 'error'); return; }
    reg.update().then(() => {
      if (reg.waiting) {
        showToast('Update available — reloading...', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast('Already up to date', 'success');
      }
    });
  }).catch(() => showToast('Update check failed', 'error'));
}

// ===== FILE PROTOCOL BANNER =====
function checkFileProtocol() {
  if (location.protocol === 'file:') {
    const banner = document.getElementById('file-banner');
    if (banner) {
      banner.className = 'file-banner';
      banner.textContent = 'You\'re viewing the local file. For sync and offline support, use the hosted version.';
    }
  }
}

// ===== ONLINE/OFFLINE LISTENERS =====
window.addEventListener('online', () => {
  if (state.needsSync && canSync()) syncToCloud();
  showToast('Back online', 'success');
});

window.addEventListener('offline', () => {
  state.syncStatus = 'offline';
  showToast('Offline — changes saved locally', '');
});

// ===== SERVICE WORKER REGISTRATION =====
if ('serviceWorker' in navigator && location.protocol !== 'file:') {
  navigator.serviceWorker.register('sw.js').then(reg => {
    // Listen for new SW waiting
    reg.addEventListener('updatefound', () => {
      const newSW = reg.installing;
      if (newSW) {
        newSW.addEventListener('statechange', () => {
          if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
            showToast('Update available — check Settings', 'success');
          }
        });
      }
    });
  }).catch(err => console.error('SW registration failed:', err));
}

// ===== STARTUP =====
loadData();
render();
checkFileProtocol();

// Initial cloud pull (on startup, if configured)
if (canSync() && navigator.onLine) {
  setTimeout(() => pullFromCloud(), 500);
}
</script>
</body>
</html>
