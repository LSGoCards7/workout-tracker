# Session Handover — 2026-02-14 (Session 2)

## Session Summary
Implemented the full PWA + Cloudflare Workers + KV cloud sync plan from a detailed design doc. The app went from a local-only `file://` HTML file to a fully deployed, installable PWA with automatic cross-device sync.

**What got done:**
1. **PWA foundation** — `manifest.json`, `sw.js` (cache-first, versioned), PNG icons (192/512/180)
2. **IndexedDB backup layer** — fire-and-forget dual-write on every `saveData()`, fallback read if localStorage empty
3. **Cloudflare Worker** — `worker/src/index.js` with GET/PUT /sync endpoints, SHA-256 key hashing, current+previous KV storage
4. **Client-side sync** — `syncToCloud()`, `pullFromCloud()`, debounced 5s, first-sync detection, conflict prompts
5. **Sync UI** — Full settings section with key setup, status badge (synced/syncing/offline/error), show/hide key, change key, enable/disable toggle
6. **Toast system** — `#toast` div outside `#app`, slide-in animation, success/error variants
7. **Online/offline listeners** — auto-sync on reconnect, offline toast
8. **SW update flow** — "Check for Updates" button in Settings
9. **Cloud-aware backup reminders** — suppressed when sync active and recent
10. **Auto-export before reset** — safety net downloads backup before data wipe
11. **File:// detection** — info banner when opened locally
12. **Deployment** — GitHub Pages (repo made public), Cloudflare Worker deployed, end-to-end sync tested and confirmed working

## What Worked / What Didn't

- **Security hook friction**: The pre-commit security hook flagged `innerHTML` usage in the `showToast()` function. Switched to `textContent` + `replaceChildren()` to satisfy it. This is a pattern to remember for future overlay/toast code.
- **Icon generation**: The subagent tried `rsvg-convert` and `sips` for SVG-to-PNG conversion but sandbox permissions blocked both. Fell back to pure Python bitmap rendering which produced functional (if basic) icons. The PNGs are valid and work as PWA icons.
- **Workers.dev TLS delay**: After first deploy, the new `lds3.workers.dev` subdomain took ~2 minutes for TLS certificate provisioning. Initial `curl` and `fetch` calls failed with SSL handshake errors. Just needed to wait.
- **GitHub Pages requires public repo**: The repo was private; free plan doesn't support Pages on private repos. Made the repo public — no secrets in the code (sync key is user-entered at runtime).
- **`gh repo edit --visibility`**: Requires `--accept-visibility-change-consequences` flag. Minor CLI quirk.
- **No npm/node initially**: Had to `brew install node` before installing wrangler. Node 25.6.1 installed.

## Key Decisions

- **Passphrase sent raw to Worker, hashed server-side**: The client sends the raw passphrase as a query parameter over HTTPS. The Worker hashes it with SHA-256 before using as KV key. This avoids needing `crypto.subtle` on the client for the sync key (though it's available). Trade-off: key is visible in server logs, but acceptable for a personal app over HTTPS.
- **Separate localStorage keys**: App data in `ironlog-data`, sync settings in `ironlog-sync`. This prevents sync metadata from polluting the data payload that gets synced to cloud.
- **Toast uses textContent not innerHTML**: Even though toast content is always app-generated, the security hook flags innerHTML. Using DOM methods (`createElement` + `textContent` + `replaceChildren`) is the safe pattern going forward.
- **Debounce skips if already syncing**: Added `state.syncStatus === 'syncing'` check in `debouncedSync()` to prevent queuing duplicate syncs during rapid saves.
- **CORS `*` on Worker**: Wide open CORS. Acceptable for a personal app — the sync key provides auth. Tightening to specific origin is a future hardening option.
- **Last-write-wins sync**: No per-date merge logic. Cloud data with newer `serverUpdatedAt` overwrites local. First sync with data on both sides prompts the user. This is simple and sufficient for 1-2 devices.

## Lessons Learned & Gotchas

- **`showToast()` must use `textContent`** — security hook catches innerHTML even for hardcoded strings. Use `pill.textContent = message; el.replaceChildren(pill)`.
- **New workers.dev subdomains need 1-2 min for TLS** — don't panic if SSL handshake fails immediately after first deploy.
- **`gh api` for Pages creation**: Use `--input -` with heredoc for JSON body, not shell-quoted `-f` params (zsh interprets brackets).
- **Worker uploaded but "No active routes"**: This happens when workers.dev subdomain isn't registered yet. After registering subdomain in Cloudflare dashboard, redeploy to get the route assigned.
- **`wrangler deploy` interactive prompt**: In non-interactive context (Claude Code), wrangler falls back to "no" for subdomain registration. Need to register via dashboard first, then redeploy.

## Next Steps
- [ ] Replace Python-generated icons with higher-quality versions (use Figma, or run `rsvg-convert` manually outside sandbox)
- [ ] Test PWA install on iPhone Safari — Add to Home Screen, verify standalone mode, verify offline loading
- [ ] Test sync end-to-end between two devices (desktop Chrome + iPhone Safari)
- [ ] Consider restricting Worker CORS to `https://lsgocards7.github.io` for security hardening
- [ ] Consider replacing `alert()`/`confirm()` dialogs with custom modals for better PWA UX
- [ ] Monitor Cloudflare free tier usage (100K requests/day limit)
- [ ] Optional: add per-date merge logic for sync conflicts instead of last-write-wins

## Important Files Map
| File | What Changed |
|------|-------------|
| `iron_log.html` | Major: +386 lines. Added manifest/SW links, IndexedDB backup, full sync system, toast, file:// banner, online/offline listeners, SW update check, cloud-aware backup, auto-export on reset. Now 1146 lines. |
| `sw.js` | **New.** 84 lines. Service worker with versioned cache, cache-first for app shell, skip sync URLs, font caching. |
| `manifest.json` | **New.** PWA manifest — name, icons, theme color, standalone display. |
| `icons/icon-192.png` | **New.** PWA icon 192x192 (Python-generated, "IL" on dark/green). |
| `icons/icon-512.png` | **New.** PWA icon 512x512. |
| `icons/apple-touch-icon.png` | **New.** Apple touch icon 180x180. |
| `worker/src/index.js` | **New.** 99 lines. Cloudflare Worker — CORS, GET/PUT /sync, SHA-256 hashing, current+previous KV, size validation. |
| `worker/wrangler.toml` | **New.** Worker config with real KV namespace ID `cceeec4e127f4e4e92b3166ca64fd6b3`. |
| `CLAUDE.md` | Updated: file structure table, data persistence (3 layers), cloud sync architecture, service worker docs. |

## Current State
- **Branch**: `main`
- **Clean working tree**: All changes committed and pushed
- **2 commits this session**:
  ```
  3fc440e Wire up Cloudflare Worker URL and KV namespace ID
  719df2e Add PWA support, service worker, and Cloudflare Workers cloud sync
  ```
- **Repo**: Public (was private, changed for GitHub Pages)
- **GitHub Pages**: Live at `https://lsgocards7.github.io/workout-tracker/iron_log.html`
- **Cloudflare Worker**: Deployed at `https://ironlog-sync.lds3.workers.dev` — tested PUT+GET successfully
- **Sync**: Confirmed working end-to-end by user ("it's working")
- **No known bugs**
- **Environment**: Node 25.6.1 + wrangler 4.65.0 installed via Homebrew. Cloudflare auth active via `wrangler login`.
